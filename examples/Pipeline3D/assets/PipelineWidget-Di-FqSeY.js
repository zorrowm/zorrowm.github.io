import{J as O,K as N,u as J,L as G,O as $}from"./vendor-09XKH5X6.js";import{d as j,ac as ee,L as ae,H as q,M as X,W as I,V as Y,P as te,p as ne,r as y,u as ie,v as oe,N as se,O as re,ad as le}from"./@vue-exp-BMz8X7Pi.js";import{d as K}from"./index-Bvhcfk1J.js";import{w as W,N as H}from"./xframelib-exp-BHnis-8Y.js";import"./@hprose-exp-zVZHOVCF.js";import"./vue-router-exp-COsaUipG.js";import"./axios-exp-DvxIUWKU.js";const ce=j({__name:"PopoverPanel",props:{isShown:O().def(!1),leftX:N().def("0px"),topY:N().def("0px"),autoHide:O().def(!1)},setup(r,{expose:a}){a(),ee(t=>({"02eea6e8":r.leftX,e74a722e:r.topY}));const o={};return Object.defineProperty(o,"__isScriptSetup",{enumerable:!1,value:!0}),o}}),ue={class:"popoverInfo"};function pe(r,a,o,t,e,l){const i=ae("VDropdown");return q(),X("div",ue,[I(i,{placement:"top",distance:10,triggers:[],shown:o.isShown,autohide:o.autoHide},{popper:Y(()=>[te(r.$slots,"content",{},void 0,!0)]),_:3},8,["shown","autohide"])])}const me=K(ce,[["render",pe],["__scopeId","data-v-c5f4fcb4"],["__file","PopoverPanel.vue"]]);function de(r){let a=Cesium.Color.STEELBLUE;switch(r){case"给水管":a=Cesium.Color.AQUA;break;case"热力":a=Cesium.Color.TOMATO;break;case"天然气":a=Cesium.Color.ORANGE;break;case"污水管":a=Cesium.Color.BLACK;break;case"雨水管":a=Cesium.Color.SADDLEBROWN;break;case"交通信号":a=Cesium.Color.DARKORCHID;break}return a}async function fe(r){const a=await W(r).catch(o=>{});if(a&&a.data)return a.data}async function ge(r){const a=await W(r).catch(o=>{});if(a&&a.data)return a.data}async function U(r,a=10){const o=r.features.length,t=Math.ceil(o/a),e=new Array;let l=0,i=a;for(let s=1;s<=t;s++)i=s*a,i>=o&&(i=o-1),e.push(r.features.slice(l,i)),l=i;return e}function Ce(r){const a=[];for(let o=0;o<360;o++){const t=Cesium.Math.toRadians(o),e=new Cesium.Cartesian2(r*Math.cos(t),r*Math.sin(t));a.push(e)}return a}async function ve(r,a,o){return a.forEach(t=>{const e=t.geometry.coordinates,l=e[0],i=e[1],s=t.properties,g=s.管线编,C=s.起点高,M=s.终点高,p=parseFloat(s.管径)/1e3,m=s.图层;o.set(g,[{name:"管线编号",value:s.管线编},{name:"类型",value:s.图层},{name:"材质",value:s.材质},{name:"长度",value:s.长度},{name:"位置",value:s.所在道},{name:"起点埋",value:s.起点埋},{name:"终点埋",value:s.终点埋},{name:"管径",value:s.管径}]);const f=de(m),c=new Cesium.PolylineVolumeGeometry({polylinePositions:Cesium.Cartesian3.fromDegreesArrayHeights([l[0],l[1],C,i[0],i[1],M]),shapePositions:Ce(p)}),v=Cesium.PolylineVolumeGeometry.createGeometry(c),_=new Cesium.GeometryInstance({geometry:v,id:g,attributes:{color:Cesium.ColorGeometryInstanceAttribute.fromColor(f)}}),w=new Cesium.PerInstanceColorAppearance({flat:!0,translucent:!1}),b=new Cesium.Primitive({geometryInstances:_,appearance:w,asynchronous:!1});r.add(b)}),r}const we=new Cesium.Material({fabric:{type:"Image",uniforms:{image:"/img/jing2.png"}}}),be=new Cesium.Material({fabric:{type:"Image",uniforms:{image:"/img/bizi.png"}}}),E=899e-8/2,he=new Cesium.MaterialAppearance({material:we,faceForward:!1}),ye=new Cesium.MaterialAppearance({material:be,faceForward:!0}),_e=new Cesium.Material({fabric:{type:"Color",uniforms:{color:new Cesium.Color(1,1,0,1)}}});new Cesium.MaterialAppearance({material:_e});async function Ae(r,a,o){const t=[],e=[];if(a.forEach(l=>{const i=l.properties,s=i.ID;i.图层,i.埋深;const g=i.井底高,C=i.地面高;let p=i.附属物==="篦子";o.set(s,[{name:"编号",value:i.ID},{name:"类型",value:i.图层},{name:"特征",value:i.特征},{name:"地面高程",value:i.地面高},{name:"井底高程",value:i.井底高},{name:"埋设方法",value:i.埋设方}]);const m=l.geometry.coordinates;let f;p?f=new Cesium.RectangleGeometry({rectangle:Cesium.Rectangle.fromDegrees(m[0]-E,m[1]-E,m[0]+E,m[1]+E),height:C+.2}):f=new Cesium.CircleGeometry({center:Cesium.Cartesian3.fromDegrees(m[0],m[1]),radius:1,height:C+1,extrudedHeight:g});const c=new Cesium.GeometryInstance({id:s,geometry:f});p?t.push(c):e.push(c)}),t.length>0){const l=new Cesium.Primitive({geometryInstances:t,appearance:ye,asynchronous:!0});l.disableDepthTestDistance=99e3,r.add(l)}if(e.length>0){const l=new Cesium.Primitive({geometryInstances:e,appearance:he,asynchronous:!0});l.disableDepthTestDistance=99e3,r.add(l)}}const Fe=j({__name:"PipelineWidget",setup(r,{expose:a}){a();const o=J();let t;ne(()=>{t!==void 0&&(clearTimeout(t),o.loading.hide())});let e;const l=y(!1),i=y(!1),s=y(!1),g=y("0px"),C=y("0px"),M=[{name:"name",label:"属性名",align:"left",field:"name"},{name:"value",align:"center",label:"值",field:"value"}],p=y([]),m=y({rowsPerPage:0});function f(){return H.CesiumViewer&&(e||(e=H.CesiumViewer)),e}let c,v=!0,_,w;const b=new Map,F=new Map,L=new Cesium.Material({fabric:{type:"Image",uniforms:{image:"/img/red.png"}}}),z=new Cesium.MaterialAppearance({material:L,faceForward:!1});let k;function B(){c&&(c.primitive&&(v?c.primitive.appearance=new Cesium.PerInstanceColorAppearance({flat:!0,translucent:!1}):c.primitive.appearance=k),e.scene.requestRender(),c=void 0)}_||fe("data/line_4490.json").then(n=>{_=n,R(n)});async function R(n){b.clear();const d=await U(n,100);n=void 0;const u=d.length;for(let h=0;h<u;h++){const D=d[h],P=new Cesium.PrimitiveCollection;e.scene.primitives.add(P),ve(P,D,b)}}w||ge("data/point_4490.json").then(async n=>{w=n,S(w)});async function S(n){F.clear();const d=await U(n,200),u=d.length;for(let h=0;h<u;h++){const D=d[h],P=new Cesium.PrimitiveCollection;e.scene.primitives.add(P),Ae(P,D,F)}}let A;o.loading.show({message:"正在加载3万多管线数据，请稍等……"}),t=setTimeout(()=>{e&&e.scene.requestRender(),o.loading.show({messageColor:"black",backgroundColor:"white",message:"正在渐进式渲染点数据……"}),t=setTimeout(()=>{o.loading.hide(),t=void 0},5e3)},7e3),ie(()=>{f(),A=new Cesium.ScreenSpaceEventHandler(e.scene.canvas),A.setInputAction(async function(n){const d=n.position;var u=e.scene.pick(n.position);u?(s.value=!1,C.value=d.y+"px",g.value=d.x+"px",c&&B(),c=u,setTimeout(()=>{s.value=!0},50),u.id.length>10?(v=!0,u.primitive.appearance=new Cesium.MaterialAppearance({material:Cesium.Material.fromType("Color"),faceForward:!0}),u.primitive.appearance.material.uniforms.color=new Cesium.Color(1,0,0,1),e.scene.requestRender(),b.size>0&&(p.value=[],p.value=b.get(u.id))):(k=u.primitive.appearance,e.scene.requestRender(),v=!1,F.size>0&&(p.value=[],p.value=F.get(u.id)))):(s.value=!1,B())},Cesium.ScreenSpaceEventType.LEFT_CLICK)}),oe(()=>{A&&A.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK),e&&e.scene.primitives.removeAll()});function Q(n,d){e&&(e.scene.globe.depthTestAgainstTerrain=n,e.scene.requestRender())}function Z(n,d){e&&(n?T():V(),e.scene.requestRender())}function T(){e.scene.screenSpaceCameraController.enableCollisionDetection=!1,e.scene.globe.translucency.enabled=!0,e.scene.globe.translucency.frontFaceAlphaByDistance=new Cesium.NearFarScalar(400,.5,8e3,.9)}function V(){e.scene.screenSpaceCameraController.enableCollisionDetection=!0,e.scene.globe.translucency.enabled=!1}const x={$q:o,get timer(){return t},set timer(n){t=n},get viewer(){return e},set viewer(n){e=n},depthRef:l,subwayRef:i,isOpen:s,leftX:g,topY:C,columns:M,rows:p,pagination:m,getViewer:f,get lastPick(){return c},set lastPick(n){c=n},get lastIsLine(){return v},set lastIsLine(n){v=n},get line4490(){return _},set line4490(n){_=n},get point4490(){return w},set point4490(n){w=n},lineMap:b,pointMap:F,imgMaterial2:L,appearanceSelected:z,get lastOldAppearance(){return k},set lastOldAppearance(n){k=n},rebackAppearance:B,loadLinesHandler:R,loadPointsHandler:S,get handler(){return A},set handler(n){A=n},depthChanged:Q,subwayChanged:Z,OpenUnderGroup:T,CloseUnderGroud:V,PopoverPanel:me};return Object.defineProperty(x,"__isScriptSetup",{enumerable:!1,value:!0}),x}}),Pe={class:"toolbarLine"},Ie=le('<div class="legendPanel" data-v-981e82b7><b data-v-981e82b7>管线图例：</b><ul data-v-981e82b7><li style="background-color:#00FFFF;" data-v-981e82b7>给水管：#00FFFF </li><li style="background-color:#FF6347;" data-v-981e82b7>热力 : #FF6347</li><li style="background-color:#FFA500;" data-v-981e82b7>天然气 :#FFA500</li><li style="background-color:#000000;color:#fff;" data-v-981e82b7>污水管 :#000000 </li><li style="background-color:#8B4513;" data-v-981e82b7>雨水管 :#8B4513</li><li style="background-color:#9932CC;" data-v-981e82b7>交通信号 :#9932CC</li><li style="background-color:#4682B4;" data-v-981e82b7>其他 :#4682B4 </li></ul></div>',1);function Me(r,a,o,t,e,l){return q(),X(re,null,[I(t.PopoverPanel,{isShown:t.isOpen,leftX:t.leftX,topY:t.topY},{content:Y(()=>[I($,{pagination:t.pagination,"onUpdate:pagination":a[0]||(a[0]=i=>t.pagination=i),title:"属性表",rows:t.rows,columns:t.columns,"row-key":"name",dense:!0},null,8,["pagination","rows"])]),_:1},8,["isShown","leftX","topY"]),se("div",Pe,[I(G,{modelValue:t.depthRef,"onUpdate:modelValue":[a[1]||(a[1]=i=>t.depthRef=i),t.depthChanged],label:"地形深度检测"},null,8,["modelValue"]),I(G,{modelValue:t.subwayRef,"onUpdate:modelValue":[a[2]||(a[2]=i=>t.subwayRef=i),t.subwayChanged],label:"地下模式"},null,8,["modelValue"])]),Ie],64)}const Te=K(Fe,[["render",Me],["__scopeId","data-v-981e82b7"],["__file","PipelineWidget.vue"]]);export{Te as default};
