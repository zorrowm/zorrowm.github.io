import{H as se,j as ie,m as ae}from"./vendor-09XKH5X6.js";import{B as le}from"./rotate-DXVpyxFQ.js";import{f as ue,u as re,g as ce,h as ge,i as de,d as pe}from"./index-Bvhcfk1J.js";import{N as e,b as D,f as fe,L as me,C as he,h as ve,k as Ce}from"./xframelib-exp-BHnis-8Y.js";import{b as Se,u as ye}from"./vue-router-exp-COsaUipG.js";import{d as _e,r as d,a as we,u as Be,L as ke,H as S,M as y,N as n,_ as k,y as K,a9 as j,U as be,W as J,a6 as z}from"./@vue-exp-BMz8X7Pi.js";import"./@hprose-exp-zVZHOVCF.js";import"./domTool-Dunoo3KF.js";import"./axios-exp-DvxIUWKU.js";const Re=_e({components:{BasicDragVerify:le},setup(){var N,Q,q;const o=d(!0);e.Loading("end");const t=we({username:"",password:""}),_=d(),w=d(),b=d("");b.value=(N=e.Config.UI)==null?void 0:N.SiteTitle;const R=d("");R.value=(Q=e.Config.UI)==null?void 0:Q.CopyRight;const l=Se(),i=ye();let u=decodeURIComponent(((q=i.query)==null?void 0:q.redirect)||"/");const G=D();let B;if(G){fe(),l&&l.replace(u).then(s=>{i.name=="login"&&l.replace("/")});return}const L=d(null);let f=!0,F=!1;const X=async()=>{var r,c;if(!F){(r=e.Message)==null||r.warn("请先人机验证！");return}if(!f){e.Logger().debug("频繁点击登录******");return}if(f=!1,t.username.trim()===""||t.password.trim()=="")return setTimeout(()=>{f=!0},2e3),(c=e.Message)==null?void 0:c.warn("用户名或密码不能为空！");let s={username:t.username.trim(),pwd:t.password.trim()};const a=await ve(s).catch(h=>{var v;(v=e.Message)==null||v.warn(`登录失败:${h.message}!`),f=!0,L.value&&(F=!1,L.value.resume())});a&&await $(a)};function Y(s){var r;F=!0;const{time:a}=s;(r=e.Message)==null||r.info(`校验成功,耗时${a}秒`)}async function $(s){var H,P,W;const a=re();a.init(s),e.User=a.id;const r=ce(),c=a.DefaultMaxRoleLevel===0;let h=!0;const v=await Ce(r,c).catch(g=>{var p;h=!1,(p=e.Message)==null||p.err("该系统未注册！")});if(f=!0,!h)return;if(e.Logger().debug(v,"登录后的系统权限"),v){const g=ge();e.Logger().debug(g,"系统路由权限");let p;g==null||g.forEach(O=>{p||(p=O),l.addRoute(O)}),p&&de(l,p)}else{(H=e.Message)==null||H.warn(t.username+"无系统权限，无法登录！");return}const C=decodeURIComponent(((P=i.query)==null?void 0:P.redirect)||"/");if(l)if(e.Logger().debug(C,"toPath"),C.startsWith("http://")||C.startsWith("https://")){const g=D();window.open(C+"#/?tk="+g.token,"_self")}else l.replace(C).then(g=>{i.name=="login"&&l.replace("/")});(W=e.Message)==null||W.msg("登录成功")}Be(async()=>{var s,a;if(B=void 0,u&&(B=(a=(s=i.query)==null?void 0:s.tk)==null?void 0:a.toString()),B&&await ue(B)){const c=D();c&&((u==null?void 0:u.indexOf("?"))>0?u+="&tk="+c.token:u+="?tk="+c.token,l.replace(u).then(h=>{i.name=="login"&&l.replace("/")}))}});function Z(){_.value&&(_.value.placeholder="请输入账号"),w.value&&(w.value.placeholder="请输入密码")}async function x(s){o.value=s,await ne()}let A=null,I="",M=d(),T=d(),m;const ee=1e3*60*2;let U=!0,V=e.Config.ServiceURL.LoginAuthURL;async function ne(){e.authSignalConnection==null&&(e.authSignalConnection=new se().withUrl(`${V}/chathub`,{skipNegotiation:!0,transport:ie.WebSockets}).withAutomaticReconnect().build(),e.authSignalConnection.serverTimeoutInMilliseconds=24e4,e.authSignalConnection.keepAliveIntervalInMilliseconds=12e4,e.authSignalConnection.on("ReturnConnectionId",s=>{I=s,E()}),e.authSignalConnection.on("QRCodeCheckMessage",(s,a)=>{T.value=s}),e.authSignalConnection.on("QRCodeSendMessage",async s=>{var a=JSON.parse(s);a.success&&a.userinfo!=null?(te(!0),m&&clearTimeout(m),me(a.userinfo.doubletoken),await $(a.userinfo)):(e.Message.info("授权登录取消"),T.value="")}),e.authSignalConnection.on("ExitLoginMessage",async(s,a)=>{e.authSignalConnection=null,he(),l.replace("login")}),await e.authSignalConnection.start(),A=e.authSignalConnection)}function E(){if(I){if(!U)return;U=!1,oe(),M.value=`${V}/api/getqrcode?connId=${I}`;return}e.Message.err("获取二维码失败")}async function te(s){try{await A.invoke("LoginSuccessMessage",s)}catch{}}function oe(){e.Logger().log("重新开始计时……"),m&&clearTimeout(m),m=setTimeout(()=>{U=!0,M.value=""},ee)}return{formState:t,systemTitle:b,handleSubmit:X,onblur:Z,nameInput:_,pwdInput:w,copyRightInfo:R,handleSuccess:Y,elDragRef:L,pwdLogin:o,changeLoginType:x,imageUrl:M,scanUser:T,getQRCodeImage:E}}}),Le={class:"container"},Fe={class:"login-logo"},Ie=n("img",{src:"/img/logo.png",alt:""},null,-1),Me={class:"login-title"},Te={key:0,class:"login"},Ue=n("div",{class:"login-top"},"用户登录",-1),De=n("img",{src:"/img/login/code.png",alt:"",width:"50",height:"50"},null,-1),$e=[De],Ae={class:"login-center clearfix"},Ve=n("div",{class:"login-center-img"},[n("img",{src:"/img/login/name.png"})],-1),Ee={class:"login-center-input"},Ne=n("div",{class:"login-center-input-text"},"账号",-1),Qe={class:"login-center clearfix"},qe=n("div",{class:"login-center-img"},[n("img",{src:"/img/login/password.png"})],-1),He={class:"login-center-input"},Pe=n("div",{class:"login-center-input-text"},"密码",-1),We={class:"login-center clearfix",style:{"margin-bottom":"5px"}},Oe={class:"login-bottom-line"},Ke=n("span",null,"忘记密码",-1),je=n("span",null,"注册新账号",-1),Je={key:1,class:"login"},ze=n("div",{class:"login-top"},"扫码登录",-1),Ge={class:"login-top-append"},Xe=n("img",{src:"/img/login/pwd.png",alt:"",width:"50",height:"50"},null,-1),Ye=[Xe],Ze={class:"login-center loginQRCode"},xe={key:0},en=n("br",null,null,-1),nn=["src"],tn={class:"login-copyright"};function on(o,t,_,w,b,R){const l=ke("BasicDragVerify");return S(),y("div",Le,[n("div",Fe,[Ie,n("span",Me,k(o.systemTitle),1)]),o.pwdLogin?(S(),y("div",Te,[Ue,n("div",{class:"righttop-login",onClick:t[0]||(t[0]=i=>o.changeLoginType(!1))},$e),n("div",Ae,[Ve,n("div",Ee,[K(n("input",{ref:"nameInput","onUpdate:modelValue":t[1]||(t[1]=i=>o.formState.username=i),type:"text",placeholder:"请输入账号",onfocus:"this.placeholder=''",onBlur:t[2]||(t[2]=i=>o.onblur())},null,544),[[j,o.formState.username]]),Ne])]),n("div",Qe,[qe,n("div",He,[K(n("input",{ref:"pwdInput","onUpdate:modelValue":t[3]||(t[3]=i=>o.formState.password=i),type:"password",placeholder:"请输入密码",onfocus:"this.placeholder=''",onBlur:t[4]||(t[4]=i=>o.onblur()),onKeyup:t[5]||(t[5]=be((...i)=>o.handleSubmit&&o.handleSubmit(...i),["enter"]))},null,544),[[j,o.formState.password]]),Pe])]),n("div",We,[J(l,{ref:"elDragRef",width:270,barStyle:{backgroundColor:"#018ffb"},onSuccess:o.handleSuccess},null,8,["onSuccess"])]),n("div",{class:"login-button",onClick:t[6]||(t[6]=(...i)=>o.handleSubmit&&o.handleSubmit(...i))},"登录"),n("div",Oe,[Ke,J(ae,{vertical:""}),je])])):(S(),y("div",Je,[ze,n("div",Ge,k(o.imageUrl?"请打开 授权宝APP 扫一扫登录":"请点击刷新二维码"),1),n("div",{class:"righttop-login",onClick:t[7]||(t[7]=i=>o.changeLoginType(!0))},Ye),n("div",Ze,[o.scanUser?(S(),y("div",xe,[z("用户:"+k(o.scanUser),1),en,z("请在手机端确认登录")])):(S(),y("img",{key:1,src:o.imageUrl,alt:"",width:"200",height:"200",style:{cursor:"pointer"},onClick:t[8]||(t[8]=i=>o.getQRCodeImage())},null,8,nn))])])),n("div",tn,k(o.copyRightInfo),1)])}const fn=pe(Re,[["render",on],["__file","index.vue"]]);export{fn as default};
