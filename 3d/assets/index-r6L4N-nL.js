import{w as I,j as M,V as k,T as E}from"./vendor-CDV5M84i.js";import{j as a,g as N,k as A,o as O}from"./xframelib-exp-CvTEfE5n.js";import{B as P}from"./rotate-Ba5UGUAD.js";import{g as D}from"./urlUtils-CEJcI5DA.js";import{b as Q,u as T}from"./vue-router-exp-BeFgxScw.js";import{d as S,a as $,r as p,R as y,M as C,L as n,z as w,ad as F,a0 as j,Q as m,X as K,v as q,x as z,N as V,Z as J,p as X,$ as Z,a1 as L}from"./@vue-exp-YaP0LnBg.js";import{_ as U}from"./index-BTOrG-4i.js";import"./@hprose-exp-DifMA6AO.js";import"./axios-exp-BH40TtQM.js";import"./domTool-Dunoo3KF.js";const G=S({__name:"AccountLogin",setup(R,{expose:e}){e();const s=$({username:"",password:""}),t=p(),i=p(),c=Q(),o=c.query.sysid;let u=!0,f=!1;const b=async()=>{if(!u){a.Logger().debug("频繁点击登录******");return}if(u=!1,s.username.trim()===""||s.password.trim()=="")return setTimeout(()=>{u=!0},2e3),a.Message.warn("用户名或密码不能为空！");let r={username:s.username.trim(),pwd:s.password.trim()};const l=await N(r).catch(v=>{a.Message.warn(`登录失败:${v.message}!`),u=!0});if(l){const v=l.Userinfo.Doubletoken.AccessToken.TokenContent;if(o){a.Logger().info("当前登录id",l.System);const B=D("");window.open(B+"?tk="+v,"_self")}else a.OneUserInfo=l.Userinfo,T().push("onelogin-portal")}};function h(){t.value&&(t.value.placeholder="请输入账号"),i.value&&(i.value.placeholder="请输入密码")}function d(r){f=!0;const{time:l}=r;a.Message.info(`校验成功,耗时${l}秒`)}const g={formState:s,nameInput:t,pwdInput:i,currentRoute:c,systemID:o,get canLoginClicked(){return u},set canLoginClicked(r){u=r},get isPassVerify(){return f},set isPassVerify(r){f=r},handleSubmit:b,onblur:h,handleSuccess:d,get BasicDragVerify(){return P}};return Object.defineProperty(g,"__isScriptSetup",{enumerable:!1,value:!0}),g}}),H={class:"login-center clearfix"},W={class:"login-center-input"},Y={class:"login-center clearfix"},ee={class:"login-center-input"},te={class:"login-center clearfix",style:{"margin-bottom":"5px"}},ne={class:"login-bottom-line"};function oe(R,e,s,t,i,c){return y(),C(K,null,[e[10]||(e[10]=n("div",{class:"login-top-center"},"用户登录",-1)),n("div",H,[e[5]||(e[5]=n("div",{class:"login-center-img"},[n("img",{src:"/img/login/name.png"})],-1)),n("div",W,[w(n("input",{ref:"nameInput","onUpdate:modelValue":e[0]||(e[0]=o=>t.formState.username=o),type:"text",placeholder:"请输入账号",onfocus:"this.placeholder=''",onBlur:e[1]||(e[1]=o=>t.onblur())},null,544),[[F,t.formState.username]]),e[4]||(e[4]=n("div",{class:"login-center-input-text"},"账号",-1))])]),n("div",Y,[e[7]||(e[7]=n("div",{class:"login-center-img"},[n("img",{src:"/img/login/password.png"})],-1)),n("div",ee,[w(n("input",{ref:"pwdInput","onUpdate:modelValue":e[2]||(e[2]=o=>t.formState.password=o),type:"password",placeholder:"请输入密码",onfocus:"this.placeholder=''",onBlur:e[3]||(e[3]=o=>t.onblur()),onKeyup:j(t.handleSubmit,["enter"])},null,544),[[F,t.formState.password]]),e[6]||(e[6]=n("div",{class:"login-center-input-text"},"密码",-1))])]),n("div",te,[m(t.BasicDragVerify,{width:270,barStyle:{backgroundColor:"#018ffb"},onSuccess:t.handleSuccess})]),n("div",{class:"login-button",onClick:t.handleSubmit},"登录"),n("div",ne,[e[8]||(e[8]=n("span",null,"忘记密码",-1)),m(I,{vertical:""}),e[9]||(e[9]=n("span",null,"注册新账号",-1))])],64)}const se=U(G,[["render",oe],["__file","AccountLogin.vue"]]),x=1e3*60,ie=S({__name:"QRCodeLogin",setup(R,{expose:e}){e();let s,t=p(""),i=p(!1),c=p(""),o;function u(){if(!o&&!o.connectionId)return;const g=Q().query.sysid,r=o.connectionId;O("/api/getqrcode","https://gis-auth.digsur.com",{connId:r,sys:g??""},void 0,"blob").then(_=>{a.Logger().log("axios调用结果",_),i.value=!1,f();let B=URL.createObjectURL(_.data);t.value=B})}function f(){a.Logger().log("重新开始计时……"),s&&clearTimeout(s),s=setTimeout(()=>{i.value=!0},x)}function b(){const g=A("http://192.168.1.123:5000/chathub");g&&(o=g,g.start().then(()=>{g.state==="Connected"&&(o=g,u())}).catch(r=>{a.Logger().error("连接SignalR服务出错了！",r)}),g.on("QRCodeCheckMessage",function(r,l){l&&r&&(c.value=r),a.Logger().log("QRCodeCheckMessage",r,l)}),g.on("QRCodeSendMessage",function(r){let l=JSON.parse(r);if(a.Logger().log("QRCodeSendMessage",l),l?.Success){let v=l?.Userinfo.Doubletoken.AccessToken.TokenContent;if(l.System){a.Logger().info("当前登录id",l.System);const B=D("");window.open(B+"?tk="+v,"_self")}else a.OneUserInfo=l.Userinfo,T().push("onelogin-portal")}else c.value="",u(),a.Message.warn("登录失败！请重新扫码登录")}))}b(),q(()=>{f()}),z(()=>{clearTimeout(s),o&&(o.off("QRCodeCheckMessage"),o.off("QRCodeSendMessage"),o.stop())});const h={get timerId(){return s},set timerId(d){s=d},timeout:x,get imgUrl(){return t},set imgUrl(d){t=d},get needRefresh(){return i},set needRefresh(d){i=d},get codeName(){return c},set codeName(d){c=d},get signalRConnection(){return o},set signalRConnection(d){o=d},getLoginQRCode:u,resetTimeOut:f,init:b};return Object.defineProperty(h,"__isScriptSetup",{enumerable:!1,value:!0}),h}}),re={class:"login-center"},le={key:0,class:"box"},ae={class:"imgInfo"},ue={key:0,class:"mask"},de=["src"],ce={class:"login-bottom-line"};function ge(R,e,s,t,i,c){return y(),C("div",null,[e[3]||(e[3]=n("div",{class:"login-top-center"},"扫码登录",-1)),n("div",re,[t.codeName?(y(),C("div",le,[n("span",null,V(t.codeName)+"正在登录...",1)])):(y(),C("div",{key:1,class:"box",onClick:t.getLoginQRCode},[e[0]||(e[0]=n("div",{class:"scaninfo"},"请打开微信小程序【帝测授权宝】扫码登录",-1)),n("div",ae,[t.needRefresh&&t.imgUrl?(y(),C("div",ue,[m(M,{flat:"",color:"primary",label:"点我刷新"})])):J("",!0),n("img",{src:t.imgUrl,alt:"用户登录二维码",style:{width:"100%"}},null,8,de)])])),n("div",ce,[e[1]||(e[1]=n("span",null,"密码登录",-1)),m(I,{dark:"",vertical:""}),e[2]||(e[2]=n("span",null,"注册新账号",-1))])])])}const fe=U(ie,[["render",ge],["__scopeId","data-v-7eade1b9"],["__file","QRCodeLogin.vue"]]),me=S({__name:"index",setup(R,{expose:e}){e(),a.Loading("end");const s=p("");s.value=a.Config.UI?.SiteTitle;const t=p("");t.value=a.Config.UI?.CopyRight;const i=p("2"),c=X(()=>{let f="right-login-switch right-login-qrcode";return i.value==="2"&&(f="right-login-switch right-login-account"),f});function o(){i.value==="1"?i.value="2":i.value="1"}const u={systemTitle:s,copyRightInfo:t,activeKey:i,getRightStyle:c,changeLoginType:o,AccountLogin:se,QRCodeLogin:fe};return Object.defineProperty(u,"__isScriptSetup",{enumerable:!1,value:!0}),u}}),pe={class:"container"},ve={class:"login"},_e={class:"login-copyright"};function ye(R,e,s,t,i,c){return y(),C("div",pe,[e[2]||(e[2]=n("div",{class:"login-logo"},[n("img",{src:"/img/logo.png",alt:""}),n("span",{class:"login-title"},"统一用户登录")],-1)),n("div",ve,[n("div",{class:Z(t.getRightStyle),onClick:e[0]||(e[0]=o=>t.changeLoginType())},null,2),m(E,{modelValue:t.activeKey,"onUpdate:modelValue":e[1]||(e[1]=o=>t.activeKey=o),animated:"",class:"shadow-2 rounded-borders"},{default:L(()=>[m(k,{name:"1"},{default:L(()=>[m(t.AccountLogin)]),_:1}),m(k,{name:"2"},{default:L(()=>[m(t.QRCodeLogin)]),_:1})]),_:1},8,["modelValue"])]),n("div",_e,V(t.copyRightInfo),1)])}const Fe=U(me,[["render",ye],["__scopeId","data-v-3aed3409"],["__file","index.vue"]]);export{Fe as default};
