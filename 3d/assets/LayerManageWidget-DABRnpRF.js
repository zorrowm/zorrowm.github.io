import{a7 as Z,a0 as $,a5 as W,a4 as x,A as J,G as ee,as as ae,I as le,a1 as te}from"./vendor-qEPl7M71.js";import{B as n,S as oe}from"./xframelib-exp-CBRV2soX.js";import{M as B}from"./MapTool-lkJYUbBB.js";import{d as se,a as v,o as ie,C as ne,M as g,e as u,_ as V,F as L,L as f,a7 as N,N as b,X as re,a6 as U,D as ue,S as de,a2 as S}from"./@vue-exp-Cbz_CXqa.js";import{_ as pe}from"./index-D2kwV854.js";import"./axios-exp-B_zfNCMU.js";import"./@iconify/vue-exp-BeT9ZUzB.js";import"./monaco-editor-exp-B01XOe8A.js";import"./vue-router-exp-U1sBIDGE.js";const ye=se({__name:"LayerManageWidget",setup(A,{expose:l}){l();const T=v("raster"),t=v("polygon"),i=v(),C=v();let a;const d=v([]),y=v([]);async function E(){if(!i.value){n.Message.info("地址不可为空");return}if(R(),T.value=="raster")if(i.value.indexOf("Capabilities")>-1||i.value.indexOf("capabilities")>-1){const e=await(await fetch(i.value))?.text();if(!e){n.Message.err("该地址获取Capabilities失败,请检查链接");return}j(e)}else F("影像图层",i.value);else if(i.value.indexOf("tile.json")>-1){const e=await(await fetch(i.value))?.json();if(!e){n.Message.err("该地址获取tile.json失败,请检查链接");return}D(e)}else if(i.value.indexOf("style.json")>-1)P();else{if(!t.value||C.value){n.Message.info("xyz矢量服务需要填写数据类型以及图层源名称");return}k("矢量图层",t.value,i.value,C.value)}}async function P(){const e=await(await fetch(i.value)).json().catch(o=>{n.Message.info("地址存在问题")});e&&(B.UpdateStyleJson(n.map,e),w(e),i.value="",n.Message.info("样式更新成功"))}async function H(){const e=B.GetTDTBaseStyle();e&&(B.UpdateStyleJson(n.map,e),w(e),i.value="",n.Message.info("初始化成功"))}function w(e){e||(e=n.map.getStyle()),e&&e.layers&&e.layers.length>0&&e.layers.forEach(o=>{d.value.push({id:o.id,name:o.id,visible:o.layout?.visibility!="none",type:o.type,source:o.source.type})})}function X(e){B.MapLayerVisible(n.map,e.id,e.visible)}const h=v(!1);function M(e){var o=a.queryRenderedFeatures(e.point);if(o&&o.length>0)if(y.value.length=0,o.forEach(p=>{if(p.properties&&Object.keys(p.properties).length>0){const s=[];for(var c in p.properties)s.push({key:c,value:p.properties[c]});y.value.push({id:p.layer.id,properties:s})}else y.value.push({id:p.layer.id,properties:[]})}),y.value.length==0)n.Message.info("点击要素暂无信息");else{var r=document.getElementById("clickFeaturePopup");r&&(r.style.top=e.point.y+"px",r.style.left=e.point.x+"px"),h.value=!h.value}}function D(e){const o={type:"vector"};e.tiles&&(o.tiles=e.tiles),e.url&&(o.url=e.url),o.minzoom=e.minzoom,o.maxzoom=e.maxzoom,e.scheme&&(o.scheme=e.scheme),e.bounds&&(o.bounds=e.bounds),a.addSource(e.id,o),e.vector_layers&&e.vector_layers.forEach(r=>{k(r.id,r.geometry_type,e.id,r.id)})}function k(e,o,r,p){const c=I(o),s={id:e,source:r,type:c,"source-layer":p};switch(c){case"fill":s.layout={visibility:"visible"},s.paint={"fill-outline-color":"#4CE600","fill-opacity":.5};break;case"line":s.layout={visibility:"visible","line-cap":"round","line-join":"round"},s.paint={"line-color":"#4CE600","line-width":2};break;case"circle":s.layout={visibility:"visible"},s.paint={"circle-radius":10,"circle-color":"#669933"};break}a.addLayer(s),d.value.push({id:e,visible:!0,source:r})}function I(e){switch(e){case"point":case"Point":case"MultiPoint":case"multipoint":return"circle";case"line":case"linestring":case"LineString":case"multiLine":return"line";case"polygon":case"Polygon":case"multipolygon":case"MultiPolygon":return"fill";default:return"line"}}function j(e){var p=new DOMParser().parseFromString(e,"application/xml").getElementsByTagName("Layer");if(p)for(let c=0;c<p.length;c++){const s=p.item(c);if(s){const K=s.getElementsByTagName("ows:Identifier")[0].childNodes[0].nodeValue,G=s.getElementsByTagName("Style")[0]?.getElementsByTagName("ows:Identifier")[0].textContent,Q=s.getElementsByTagName("TileMatrixSetLink")[0]?.getElementsByTagName("TileMatrixSet")[0].textContent,O=s.getElementsByTagName("ows:WGS84BoundingBox")[0]?.getElementsByTagName("ows:LowerCorner")[0].textContent,_=s.getElementsByTagName("ows:WGS84BoundingBox")[0]?.getElementsByTagName("ows:UpperCorner")[0].textContent;let m=s.getElementsByTagName("ResourceURL")[0].attributes.getNamedItem("template")?.value;if(m){G&&(m=m.replace("{Style}",G)),Q&&(m=m.replace("{TileMatrixSet}",Q)),m=m.replace("{TileMatrix}/{TileRow}/{TileCol}","{z}/{y}/{x}");let q;O&&_&&(q=[...O.split(" "),..._.split(" ")].map(Y=>Number(Y))),F(K??oe(),m,q)}}}}function F(e,o,r){a.addSource(e,{type:"raster",tiles:[o],tileSize:256,minzoom:1,bounds:r}),a.addLayer({id:e,type:"raster",layout:{visibility:"visible"},source:e}),d.value.push({id:e,visible:!0,source:e})}function R(){d.value&&d.value.length&&(d.value.forEach(e=>{a.getSource(e.source)&&a.removeSource(e.source),a.removeLayer(e.id)}),d.value.length=0)}ie(async()=>{n.map&&(a=n.map,a.on("click",M))}),ne(()=>{a&&a.off("click",M)});const z={shape:T,shapeType:t,layerUrl:i,vectorLayerName:C,get map(){return a},set map(e){a=e},layerList:d,featuresInfo:y,addLayer:E,UpdateStyle:P,initStyle:H,GetMapLayer:w,LayerSwitch:X,visible:h,GetFeatureInfo:M,LoadTileJson:D,VectorLayerStyle:k,GetLayerTypeByGeom:I,LoadCapabilities:j,addRasterSource:F,RemiveSourceLayer:R};return Object.defineProperty(z,"__isScriptSetup",{enumerable:!1,value:!0}),z}}),ce={class:"layerPanel q-pt-md"},me={class:"layerListPanel q-ma-md"},fe={style:{"max-width":"300px","max-height":"400px",overflow:"auto"}};function ve(A,l,T,t,i,C){return f(),g(L,null,[u(Z,{class:"mainPanel q-pa-md"},{default:V(()=>[u(W,{modelValue:t.layerUrl,"onUpdate:modelValue":l[0]||(l[0]=a=>t.layerUrl=a),outlined:"",dense:"",label:"图层地址"},null,8,["modelValue"]),l[13]||(l[13]=N(" 图层类型: ")),u(x,{modelValue:t.shape,"onUpdate:modelValue":l[1]||(l[1]=a=>t.shape=a),dense:"",val:"raster",label:"影像"},null,8,["modelValue"]),u(x,{modelValue:t.shape,"onUpdate:modelValue":l[2]||(l[2]=a=>t.shape=a),dense:"",val:"vector",label:"矢量"},null,8,["modelValue"]),t.shape=="vector"?(f(),g(L,{key:0},[l[10]||(l[10]=b("br",null,null,-1)),u(W,{modelValue:t.vectorLayerName,"onUpdate:modelValue":l[3]||(l[3]=a=>t.vectorLayerName=a),outlined:"",dense:"",label:"图层源名称"},null,8,["modelValue"]),l[11]||(l[11]=N(" 矢量类型: ")),u(x,{modelValue:t.shapeType,"onUpdate:modelValue":l[4]||(l[4]=a=>t.shapeType=a),dense:"",val:"polygon",label:"面"},null,8,["modelValue"]),u(x,{modelValue:t.shapeType,"onUpdate:modelValue":l[5]||(l[5]=a=>t.shapeType=a),dense:"",val:"line",label:"线"},null,8,["modelValue"]),u(x,{modelValue:t.shapeType,"onUpdate:modelValue":l[6]||(l[6]=a=>t.shapeType=a),dense:"",val:"point",label:"点"},null,8,["modelValue"])],64)):re("",!0),l[14]||(l[14]=b("br",null,null,-1)),u(J,{color:"primary",label:"添加图层",onClick:l[7]||(l[7]=a=>t.addLayer())}),u(J,{color:"primary",label:"初始样式",onClick:l[8]||(l[8]=a=>t.initStyle())}),b("div",ce,[l[12]||(l[12]=b("div",{class:"titlePanel"}," 图层列表 ",-1)),b("div",me,[u(ee,{bordered:"",separator:"",dense:""},{default:V(()=>[(f(!0),g(L,null,U(t.layerList,(a,d)=>ue((f(),de(le,{clickable:"",class:"row items-center",key:d},{default:V(()=>[u(ae,{modelValue:a.visible,"onUpdate:modelValue":[y=>a.visible=y,y=>t.LayerSwitch(a)]},null,8,["modelValue","onUpdate:modelValue"]),N(" "+S(a.id),1)]),_:2},1024)),[[te]])),128))]),_:1})])])]),_:1}),u($,{"model-value":t.visible,target:"#clickFeaturePopup","transition-show":"flip-up","transition-hide":"flip-down",onHide:l[9]||(l[9]=a=>t.visible=!1)},{default:V(()=>[b("div",fe,[(f(!0),g(L,null,U(t.featuresInfo,(a,d)=>(f(),g("div",{class:"q-pa-sm",key:d},[b("div",null," 图层名称:"+S(a.id),1),(f(!0),g(L,null,U(a.properties,(y,E)=>(f(),g("div",{key:E},S(y.key)+":"+S(y.value),1))),128))]))),128))])]),_:1},8,["model-value"])],64)}const we=pe(ye,[["render",ve],["__scopeId","data-v-24d0b8dc"],["__file","LayerManageWidget.vue"]]);export{we as default};
