import{m as x,e as V,W as h,X as D}from"./quasar-exp-B7YDMHDE.js";import{W as s,t as B,A as q,L as A}from"./xframelib-exp-uSJ3EBow.js";import{d as w,q as N,r as g,b as f,e as v,k as t,j as b,ag as I,a2 as O,i as c,F as K,o as j,a as F,I as R,a6 as S,g as P,c as W,a1 as z,a3 as k}from"./@vue-exp-CzdoyapG.js";import{g as T}from"./urlUtils-DZs0CCYb.js";import{u as $,b as Q}from"./vue-router-exp-B23Vo4Jw.js";import{_ as M}from"./index-DylLUN-r.js";import"./axios-exp-C7rfqWEd.js";import"./vendor-CSzZZ-de.js";import"./lottie-web-exp-CIY4INm7.js";import"./monaco-editor-exp-BNK_u0iZ.js";import"./@iconify/vue-exp-BLEeEXwl.js";import"./xgis-cesium-exp-Cbv1lISI.js";const E={class:"login-center clearfix"},J={class:"login-center-input"},X={class:"login-center clearfix"},G={class:"login-center-input"},H={class:"login-bottom-line"},Y=w({__name:"AccountLogin",setup(L){const n=N({username:"",password:""}),d=g(),i=g(),l=$().query.sysid;let r=!0;const a=async()=>{if(!r){s.Logger().debug("频繁点击登录******");return}if(r=!1,n.username.trim()===""||n.password.trim()=="")return setTimeout(()=>{r=!0},2e3),s.Message.warn("用户名或密码不能为空！");let y={username:n.username.trim(),pwd:n.password.trim()};const e=await B(y).catch(o=>{s.Message.warn(`登录失败:${o.message}!`),r=!0});if(e){const o=e.Userinfo.Doubletoken.AccessToken.TokenContent;if(l){s.Logger().info("当前登录id",e.System);const _=T("");window.open(_+"?tk="+o,"_self")}else s.OneUserInfo=e.Userinfo,Q().push("onelogin-portal")}};function m(){d.value&&(d.value.placeholder="请输入账号"),i.value&&(i.value.placeholder="请输入密码")}return(y,e)=>(f(),v(K,null,[e[10]||(e[10]=t("div",{class:"login-top-center"},"用户登录",-1)),t("div",E,[e[5]||(e[5]=t("div",{class:"login-center-img"},[t("img",{src:"img/login/name.png"})],-1)),t("div",J,[b(t("input",{ref_key:"nameInput",ref:d,"onUpdate:modelValue":e[0]||(e[0]=o=>n.username=o),type:"text",placeholder:"请输入账号",onfocus:"this.placeholder=''",onBlur:e[1]||(e[1]=o=>m())},null,544),[[I,n.username]]),e[4]||(e[4]=t("div",{class:"login-center-input-text"},"账号",-1))])]),t("div",X,[e[7]||(e[7]=t("div",{class:"login-center-img"},[t("img",{src:"img/login/password.png"})],-1)),t("div",G,[b(t("input",{ref_key:"pwdInput",ref:i,"onUpdate:modelValue":e[2]||(e[2]=o=>n.password=o),type:"password",placeholder:"请输入密码",onfocus:"this.placeholder=''",onBlur:e[3]||(e[3]=o=>m()),onKeyup:O(a,["enter"])},null,544),[[I,n.password]]),e[6]||(e[6]=t("div",{class:"login-center-input-text"},"密码",-1))])]),t("div",{class:"login-button",onClick:a},"登录"),t("div",H,[e[8]||(e[8]=t("span",null,"忘记密码",-1)),c(x,{vertical:""}),e[9]||(e[9]=t("span",null,"注册新账号",-1))])],64))}}),Z={class:"login-center"},ee={key:0,class:"box"},te={class:"imgInfo"},oe={key:0,class:"mask"},se=["src"],ne={class:"login-bottom-line"},ie=1e3*60,le=w({__name:"QRCodeLogin",setup(L){let n,d=g(""),i=g(!1),p=g(""),l;function r(){if(!l&&!l.connectionId)return;const e=$().query.sysid,o=l.connectionId;A("/api/getqrcode","https://gis-auth.digsur.com",{connId:o,sys:e??""},void 0,"blob").then(U=>{s.Logger().log("axios调用结果",U),i.value=!1,a();let C=URL.createObjectURL(U.data);d.value=C})}function a(){s.Logger().log("重新开始计时……"),n&&clearTimeout(n),n=setTimeout(()=>{i.value=!0},ie)}function m(){const e=q("http://192.168.1.123:5000/chathub");e&&(l=e,e.start().then(()=>{e.state==="Connected"&&(l=e,r())}).catch(o=>{s.Logger().error("连接SignalR服务出错了！",o)}),e.on("QRCodeCheckMessage",function(o,u){u&&o&&(p.value=o),s.Logger().log("QRCodeCheckMessage",o,u)}),e.on("QRCodeSendMessage",function(o){let u=JSON.parse(o);if(s.Logger().log("QRCodeSendMessage",u),u?.Success){let _=u?.Userinfo.Doubletoken.AccessToken.TokenContent;if(u.System){s.Logger().info("当前登录id",u.System);const C=T("");window.open(C+"?tk="+_,"_self")}else s.OneUserInfo=u.Userinfo,Q().push("onelogin-portal")}else p.value="",r(),s.Message.warn("登录失败！请重新扫码登录")}))}return m(),j(()=>{a()}),F(()=>{clearTimeout(n),l&&(l.off("QRCodeCheckMessage"),l.off("QRCodeSendMessage"),l.stop())}),(y,e)=>(f(),v("div",null,[e[3]||(e[3]=t("div",{class:"login-top-center"},"扫码登录",-1)),t("div",Z,[R(p)?(f(),v("div",ee,[t("span",null,S(R(p))+"正在登录...",1)])):(f(),v("div",{key:1,class:"box",onClick:r},[e[0]||(e[0]=t("div",{class:"scaninfo"},"请打开微信小程序【帝测授权宝】扫码登录",-1)),t("div",te,[R(i)&&R(d)?(f(),v("div",oe,[c(V,{flat:"",color:"primary",label:"点我刷新"})])):P("",!0),t("img",{src:R(d),alt:"用户登录二维码",style:{width:"100%"}},null,8,se)])])),t("div",ne,[e[1]||(e[1]=t("span",null,"密码登录",-1)),c(x,{dark:"",vertical:""}),e[2]||(e[2]=t("span",null,"注册新账号",-1))])])]))}}),re=M(le,[["__scopeId","data-v-29f2f14f"]]),ae={class:"container"},ue={class:"login"},de={class:"login-copyright"},ce=w({__name:"index",setup(L){s.Loading("end");const n=g("");n.value=s.Config.UI?.SiteTitle;const d=g("");d.value=s.Config.UI?.CopyRight;const i=g("2"),p=W(()=>{let r="right-login-switch right-login-qrcode";return i.value==="2"&&(r="right-login-switch right-login-account"),r});function l(){i.value==="1"?i.value="2":i.value="1"}return(r,a)=>(f(),v("div",ae,[a[2]||(a[2]=t("div",{class:"login-logo"},[t("img",{src:"img/logo.png",alt:""}),t("span",{class:"login-title"},"统一用户登录")],-1)),t("div",ue,[t("div",{class:z(p.value),onClick:a[0]||(a[0]=m=>l())},null,2),c(D,{modelValue:i.value,"onUpdate:modelValue":a[1]||(a[1]=m=>i.value=m),animated:"",class:"shadow-2 rounded-borders"},{default:k(()=>[c(h,{name:"1"},{default:k(()=>[c(Y)]),_:1}),c(h,{name:"2"},{default:k(()=>[c(re)]),_:1})]),_:1},8,["modelValue"])]),t("div",de,S(d.value),1)]))}}),Le=M(ce,[["__scopeId","data-v-99e74ecc"]]);export{Le as default};
