import{m as J}from"./quasar-exp-BsaNoQ7w.js";import{r as X,u as Y,g as Z,c as x,s as _,_ as ee}from"./index-BQ7ovaqR.js";import{B as t,D as L,P as ne,I as te,d as oe,H as ie,c as se}from"./xframelib-exp-CMLeiWD4.js";import{b as le,u as ue}from"./vue-router-exp-CO9L2VdX.js";import{d as ae,r as u,q as re,o as ge,b as m,e as f,l as n,a7 as w,k as P,ai as Q,a3 as de,j as pe,ac as V}from"./@vue-exp-Bws36Ke9.js";import{cF as ce,cG as me}from"./vendor-DJm_4oaR.js";import"./monaco-editor-exp-BNK_u0iZ.js";import"./xgis-cesium-exp-Hv7oMXHX.js";import"./lottie-web-exp-CIY4INm7.js";import"./axios-exp-C7rfqWEd.js";import"./@iconify/vue-exp-Q9Q0SWJB.js";const fe=ae({setup(){const i=u(!0);t.Loading("end");const e=re({username:"",password:""}),v=u(),h=u(),k=u("");k.value=t.Config.UI?.SiteTitle;const B=u("");B.value=t.Config.UI?.CopyRight;const o=le(),a=ue();let r=decodeURIComponent(a.query?.redirect||"/");const q=L();let C;if(q){ne(),o&&o.replace(r).then(l=>{a.name=="login"&&o.replace("/")});return}let d=!0;const N=async()=>{if(!d){t.Logger().debug("频繁点击登录******");return}if(d=!1,e.username.trim()===""||e.password.trim()=="")return setTimeout(()=>{d=!0},2e3),t.Message?.warn("用户名或密码不能为空！");let l={username:e.username.trim(),pwd:e.password.trim()};const s=await te(l).catch(S=>{t.Message?.warn(`登录失败:${S.message}!`),d=!0});s&&await T(s)};async function T(l){const s=Y();s.init(l),t.User=s.id;const S=Z(),G=s.DefaultMaxRoleLevel===0;let $=!0;const A=await oe(S,G).catch(g=>{$=!1,t.Message?.err("该系统未注册！")});if(d=!0,!$)return;if(t.Logger().debug(A,"登录后的系统权限"),A){const g=x();t.Logger().debug(g,"系统路由权限");let y;g?.forEach(E=>{y||(y=E),o.addRoute(E)}),y&&_(o,y)}else{t.Message?.warn(e.username+"无系统权限，无法登录！");return}const c=decodeURIComponent(a.query?.redirect||"/");if(o)if(t.Logger().debug(c,"toPath"),c.startsWith("http://")||c.startsWith("https://")){const g=L();window.open(c+"#/?tk="+g.token,"_self")}else o.replace(c).then(g=>{a.name=="login"&&o.replace("/")});t.Message?.msg("登录成功")}ge(async()=>{if(C=void 0,r&&(C=a.query?.tk?.toString()),C&&await X(C)){const s=L();s&&(r?.indexOf("?")>0?r+="&tk="+s.token:r+="?tk="+s.token,o.replace(r).then(S=>{a.name=="login"&&o.replace("/")}))}});function H(){v.value&&(v.value.placeholder="请输入账号"),h.value&&(h.value.placeholder="请输入密码")}async function O(l){i.value=l,await K()}let M=null,b="",R=u(),I=u(),p;const W=1e3*60*2;let F=!0,U=t.Config.ServiceURL.LoginAuthURL;async function K(){t.authSignalConnection==null&&(t.authSignalConnection=new ce().withUrl(`${U}/chathub`,{skipNegotiation:!0,transport:me.WebSockets}).withAutomaticReconnect().build(),t.authSignalConnection.serverTimeoutInMilliseconds=24e4,t.authSignalConnection.keepAliveIntervalInMilliseconds=12e4,t.authSignalConnection.on("ReturnConnectionId",l=>{b=l,D()}),t.authSignalConnection.on("QRCodeCheckMessage",(l,s)=>{I.value=l}),t.authSignalConnection.on("QRCodeSendMessage",async l=>{var s=JSON.parse(l);s.success&&s.userinfo!=null?(j(!0),p&&clearTimeout(p),ie(s.userinfo.doubletoken),await T(s.userinfo)):(t.Message.info("授权登录取消"),I.value="")}),t.authSignalConnection.on("ExitLoginMessage",async(l,s)=>{t.authSignalConnection=null,se(),o.replace("login")}),await t.authSignalConnection.start(),M=t.authSignalConnection)}function D(){if(b){if(!F)return;F=!1,z(),R.value=`${U}/api/getqrcode?connId=${b}`;return}t.Message.err("获取二维码失败")}async function j(l){try{await M.invoke("LoginSuccessMessage",l)}catch{}}function z(){t.Logger().log("重新开始计时……"),p&&clearTimeout(p),p=setTimeout(()=>{F=!0,R.value=""},W)}return{formState:e,systemTitle:k,handleSubmit:N,onblur:H,nameInput:v,pwdInput:h,copyRightInfo:B,pwdLogin:i,changeLoginType:O,imageUrl:R,scanUser:I,getQRCodeImage:D}}}),ve={class:"container"},he={class:"login-logo"},Ce={class:"login-title"},Se={key:0,class:"login"},ye={class:"login-center clearfix"},we={class:"login-center-input"},ke={class:"login-center clearfix"},Be={class:"login-center-input"},be={class:"login-bottom-line"},Re={key:1,class:"login"},Ie={class:"login-top-append"},Fe={class:"login-center loginQRCode"},Le={key:0},Te=["src"],Me={class:"login-copyright"};function Ue(i,e,v,h,k,B){return m(),f("div",ve,[n("div",he,[e[9]||(e[9]=n("img",{src:"img/logo.png",alt:""},null,-1)),n("span",Ce,w(i.systemTitle),1)]),i.pwdLogin?(m(),f("div",Se,[e[17]||(e[17]=n("div",{class:"login-top"},"用户登录",-1)),n("div",{class:"righttop-login",onClick:e[0]||(e[0]=o=>i.changeLoginType(!1))},e[10]||(e[10]=[n("img",{src:"img/login/code.png",alt:"",width:"50",height:"50"},null,-1)])),n("div",ye,[e[12]||(e[12]=n("div",{class:"login-center-img"},[n("img",{src:"img/login/name.png"})],-1)),n("div",we,[P(n("input",{ref:"nameInput","onUpdate:modelValue":e[1]||(e[1]=o=>i.formState.username=o),type:"text",placeholder:"请输入账号",onfocus:"this.placeholder=''",onBlur:e[2]||(e[2]=o=>i.onblur())},null,544),[[Q,i.formState.username]]),e[11]||(e[11]=n("div",{class:"login-center-input-text"},"账号",-1))])]),n("div",ke,[e[14]||(e[14]=n("div",{class:"login-center-img"},[n("img",{src:"img/login/password.png"})],-1)),n("div",Be,[P(n("input",{ref:"pwdInput","onUpdate:modelValue":e[3]||(e[3]=o=>i.formState.password=o),type:"password",placeholder:"请输入密码",onfocus:"this.placeholder=''",onBlur:e[4]||(e[4]=o=>i.onblur()),onKeyup:e[5]||(e[5]=de((...o)=>i.handleSubmit&&i.handleSubmit(...o),["enter"]))},null,544),[[Q,i.formState.password]]),e[13]||(e[13]=n("div",{class:"login-center-input-text"},"密码",-1))])]),n("div",{class:"login-button",onClick:e[6]||(e[6]=(...o)=>i.handleSubmit&&i.handleSubmit(...o))},"登录"),n("div",be,[e[15]||(e[15]=n("span",null,"忘记密码",-1)),pe(J,{vertical:""}),e[16]||(e[16]=n("span",null,"注册新账号",-1))])])):(m(),f("div",Re,[e[21]||(e[21]=n("div",{class:"login-top"},"扫码登录",-1)),n("div",Ie,w(i.imageUrl?"请打开 授权宝APP 扫一扫登录":"请点击刷新二维码"),1),n("div",{class:"righttop-login",onClick:e[7]||(e[7]=o=>i.changeLoginType(!0))},e[18]||(e[18]=[n("img",{src:"img/login/pwd.png",alt:"",width:"50",height:"50"},null,-1)])),n("div",Fe,[i.scanUser?(m(),f("div",Le,[V("用户:"+w(i.scanUser),1),e[19]||(e[19]=n("br",null,null,-1)),e[20]||(e[20]=V("请在手机端确认登录"))])):(m(),f("img",{key:1,src:i.imageUrl,alt:"",width:"200",height:"200",style:{cursor:"pointer"},onClick:e[8]||(e[8]=o=>i.getQRCodeImage())},null,8,Te))])])),n("div",Me,w(i.copyRightInfo),1)])}const We=ee(fe,[["render",Ue],["__file","index.vue"]]);export{We as default};
