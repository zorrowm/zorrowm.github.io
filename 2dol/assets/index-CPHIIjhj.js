import{$ as I,J as V,an as F,ao as M}from"./vendor-CcHNtcKJ.js";import{B as r,P,p as N,C as $}from"./xframelib-exp-CxzDUbp4.js";import{g as D}from"./urlUtils-dFpGY-z-.js";import{b as Q,u as T}from"./vue-router-exp-B0kidEOa.js";import{d as h,e as A,r as p,X as _,$ as C,a0 as n,E as k,aj as w,a5 as O,c as f,F as j,b as K,D as q,aa as E,a2 as J,a as z,a4 as X,a6 as L}from"./@vue-exp-DTehQd6t.js";import{_ as S}from"./index-jafnMoOd.js";import"./@hprose-exp-CYjcO8Nw.js";import"./axios-exp-B_zfNCMU.js";import"./@iconify/vue-exp-Ct1khs4G.js";const G=h({__name:"AccountLogin",setup(y,{expose:e}){e();const s=A({username:"",password:""}),t=p(),i=p(),g=Q(),o=g.query.sysid;let c=!0,m=!1;const R=async()=>{if(!c){r.Logger().debug("频繁点击登录******");return}if(c=!1,s.username.trim()===""||s.password.trim()=="")return setTimeout(()=>{c=!0},2e3),r.Message.warn("用户名或密码不能为空！");let l={username:s.username.trim(),pwd:s.password.trim()};const u=await P(l).catch(d=>{r.Message.warn(`登录失败:${d.message}!`),c=!0});if(u){const d=u.Userinfo.Doubletoken.AccessToken.TokenContent;if(o){r.Logger().info("当前登录id",u.System);const v=D("");window.open(v+"?tk="+d,"_self")}else r.OneUserInfo=u.Userinfo,T().push("onelogin-portal")}};function B(){t.value&&(t.value.placeholder="请输入账号"),i.value&&(i.value.placeholder="请输入密码")}const a={formState:s,nameInput:t,pwdInput:i,currentRoute:g,systemID:o,get canLoginClicked(){return c},set canLoginClicked(l){c=l},get isPassVerify(){return m},set isPassVerify(l){m=l},handleSubmit:R,onblur:B};return Object.defineProperty(a,"__isScriptSetup",{enumerable:!1,value:!0}),a}}),H={class:"login-center clearfix"},W={class:"login-center-input"},Y={class:"login-center clearfix"},Z={class:"login-center-input"},ee={class:"login-bottom-line"};function te(y,e,s,t,i,g){return _(),C(j,null,[e[10]||(e[10]=n("div",{class:"login-top-center"},"用户登录",-1)),n("div",H,[e[5]||(e[5]=n("div",{class:"login-center-img"},[n("img",{src:"img/login/name.png"})],-1)),n("div",W,[k(n("input",{ref:"nameInput","onUpdate:modelValue":e[0]||(e[0]=o=>t.formState.username=o),type:"text",placeholder:"请输入账号",onfocus:"this.placeholder=''",onBlur:e[1]||(e[1]=o=>t.onblur())},null,544),[[w,t.formState.username]]),e[4]||(e[4]=n("div",{class:"login-center-input-text"},"账号",-1))])]),n("div",Y,[e[7]||(e[7]=n("div",{class:"login-center-img"},[n("img",{src:"img/login/password.png"})],-1)),n("div",Z,[k(n("input",{ref:"pwdInput","onUpdate:modelValue":e[2]||(e[2]=o=>t.formState.password=o),type:"password",placeholder:"请输入密码",onfocus:"this.placeholder=''",onBlur:e[3]||(e[3]=o=>t.onblur()),onKeyup:O(t.handleSubmit,["enter"])},null,544),[[w,t.formState.password]]),e[6]||(e[6]=n("div",{class:"login-center-input-text"},"密码",-1))])]),n("div",{class:"login-button",onClick:t.handleSubmit},"登录"),n("div",ee,[e[8]||(e[8]=n("span",null,"忘记密码",-1)),f(I,{vertical:""}),e[9]||(e[9]=n("span",null,"注册新账号",-1))])],64)}const ne=S(G,[["render",te],["__file","AccountLogin.vue"]]),x=1e3*60,oe=h({__name:"QRCodeLogin",setup(y,{expose:e}){e();let s,t=p(""),i=p(!1),g=p(""),o;function c(){if(!o&&!o.connectionId)return;const l=Q().query.sysid,u=o.connectionId;$("/api/getqrcode","https://gis-auth.digsur.com",{connId:u,sys:l??""},void 0,"blob").then(v=>{r.Logger().log("axios调用结果",v),i.value=!1,m();let U=URL.createObjectURL(v.data);t.value=U})}function m(){r.Logger().log("重新开始计时……"),s&&clearTimeout(s),s=setTimeout(()=>{i.value=!0},x)}function R(){const l=N("http://192.168.1.123:5000/chathub");l&&(o=l,l.start().then(()=>{l.state==="Connected"&&(o=l,c())}).catch(u=>{r.Logger().error("连接SignalR服务出错了！",u)}),l.on("QRCodeCheckMessage",function(u,d){d&&u&&(g.value=u),r.Logger().log("QRCodeCheckMessage",u,d)}),l.on("QRCodeSendMessage",function(u){let d=JSON.parse(u);if(r.Logger().log("QRCodeSendMessage",d),d?.Success){let b=d?.Userinfo.Doubletoken.AccessToken.TokenContent;if(d.System){r.Logger().info("当前登录id",d.System);const U=D("");window.open(U+"?tk="+b,"_self")}else r.OneUserInfo=d.Userinfo,T().push("onelogin-portal")}else g.value="",c(),r.Message.warn("登录失败！请重新扫码登录")}))}R(),K(()=>{m()}),q(()=>{clearTimeout(s),o&&(o.off("QRCodeCheckMessage"),o.off("QRCodeSendMessage"),o.stop())});const B={get timerId(){return s},set timerId(a){s=a},timeout:x,get imgUrl(){return t},set imgUrl(a){t=a},get needRefresh(){return i},set needRefresh(a){i=a},get codeName(){return g},set codeName(a){g=a},get signalRConnection(){return o},set signalRConnection(a){o=a},getLoginQRCode:c,resetTimeOut:m,init:R};return Object.defineProperty(B,"__isScriptSetup",{enumerable:!1,value:!0}),B}}),se={class:"login-center"},ie={key:0,class:"box"},re={class:"imgInfo"},le={key:0,class:"mask"},ae=["src"],ue={class:"login-bottom-line"};function de(y,e,s,t,i,g){return _(),C("div",null,[e[3]||(e[3]=n("div",{class:"login-top-center"},"扫码登录",-1)),n("div",se,[t.codeName?(_(),C("div",ie,[n("span",null,E(t.codeName)+"正在登录...",1)])):(_(),C("div",{key:1,class:"box",onClick:t.getLoginQRCode},[e[0]||(e[0]=n("div",{class:"scaninfo"},"请打开微信小程序【帝测授权宝】扫码登录",-1)),n("div",re,[t.needRefresh&&t.imgUrl?(_(),C("div",le,[f(V,{flat:"",color:"primary",label:"点我刷新"})])):J("",!0),n("img",{src:t.imgUrl,alt:"用户登录二维码",style:{width:"100%"}},null,8,ae)])])),n("div",ue,[e[1]||(e[1]=n("span",null,"密码登录",-1)),f(I,{dark:"",vertical:""}),e[2]||(e[2]=n("span",null,"注册新账号",-1))])])])}const ce=S(oe,[["render",de],["__scopeId","data-v-0ee0d0ff"],["__file","QRCodeLogin.vue"]]),ge=h({__name:"index",setup(y,{expose:e}){e(),r.Loading("end");const s=p("");s.value=r.Config.UI?.SiteTitle;const t=p("");t.value=r.Config.UI?.CopyRight;const i=p("2"),g=z(()=>{let m="right-login-switch right-login-qrcode";return i.value==="2"&&(m="right-login-switch right-login-account"),m});function o(){i.value==="1"?i.value="2":i.value="1"}const c={systemTitle:s,copyRightInfo:t,activeKey:i,getRightStyle:g,changeLoginType:o,AccountLogin:ne,QRCodeLogin:ce};return Object.defineProperty(c,"__isScriptSetup",{enumerable:!1,value:!0}),c}}),me={class:"container"},fe={class:"login"},pe={class:"login-copyright"};function ve(y,e,s,t,i,g){return _(),C("div",me,[e[2]||(e[2]=n("div",{class:"login-logo"},[n("img",{src:"img/logo.png",alt:""}),n("span",{class:"login-title"},"统一用户登录")],-1)),n("div",fe,[n("div",{class:X(t.getRightStyle),onClick:e[0]||(e[0]=o=>t.changeLoginType())},null,2),f(M,{modelValue:t.activeKey,"onUpdate:modelValue":e[1]||(e[1]=o=>t.activeKey=o),animated:"",class:"shadow-2 rounded-borders"},{default:L(()=>[f(F,{name:"1"},{default:L(()=>[f(t.AccountLogin)]),_:1}),f(F,{name:"2"},{default:L(()=>[f(t.QRCodeLogin)]),_:1})]),_:1},8,["modelValue"])]),n("div",pe,E(t.copyRightInfo),1)])}const Se=S(ge,[["render",ve],["__scopeId","data-v-76376cb2"],["__file","index.vue"]]);export{Se as default};
