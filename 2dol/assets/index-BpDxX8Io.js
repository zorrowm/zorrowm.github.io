import{a0 as I,T as E,an as F,ao as M}from"./vendor-OKllBdZ9.js";import{B as r,x as N,t as P,S as A}from"./xframelib-exp-AfjEc0Ac.js";import{g as D}from"./urlUtils-CSZmjSRu.js";import{b as T,u as Q}from"./vue-router-exp-ButTbbfG.js";import{d as h,e as O,r as p,P as _,U as y,V as n,E as k,af as w,_ as $,c as m,F as K,b as j,D as q,a3 as V,X as z,a as J,Z as X,$ as L}from"./@vue-exp-Mkau1HGZ.js";import{_ as S}from"./index-KDDSQM1z.js";import"./axios-exp-C7rfqWEd.js";import"./@iconify/vue-exp-DwwUNauw.js";import"./monaco-editor-exp-B01XOe8A.js";const Z=h({__name:"AccountLogin",setup(C,{expose:e}){e();const s=O({username:"",password:""}),t=p(),i=p(),g=T(),o=g.query.sysid;let c=!0,f=!1;const R=async()=>{if(!c){r.Logger().debug("频繁点击登录******");return}if(c=!1,s.username.trim()===""||s.password.trim()=="")return setTimeout(()=>{c=!0},2e3),r.Message.warn("用户名或密码不能为空！");let l={username:s.username.trim(),pwd:s.password.trim()};const a=await N(l).catch(d=>{r.Message.warn(`登录失败:${d.message}!`),c=!0});if(a){const d=a.Userinfo.Doubletoken.AccessToken.TokenContent;if(o){r.Logger().info("当前登录id",a.System);const v=D("");window.open(v+"?tk="+d,"_self")}else r.OneUserInfo=a.Userinfo,Q().push("onelogin-portal")}};function B(){t.value&&(t.value.placeholder="请输入账号"),i.value&&(i.value.placeholder="请输入密码")}const u={formState:s,nameInput:t,pwdInput:i,currentRoute:g,systemID:o,get canLoginClicked(){return c},set canLoginClicked(l){c=l},get isPassVerify(){return f},set isPassVerify(l){f=l},handleSubmit:R,onblur:B};return Object.defineProperty(u,"__isScriptSetup",{enumerable:!1,value:!0}),u}}),G={class:"login-center clearfix"},H={class:"login-center-input"},W={class:"login-center clearfix"},Y={class:"login-center-input"},ee={class:"login-bottom-line"};function te(C,e,s,t,i,g){return _(),y(K,null,[e[10]||(e[10]=n("div",{class:"login-top-center"},"用户登录",-1)),n("div",G,[e[5]||(e[5]=n("div",{class:"login-center-img"},[n("img",{src:"img/login/name.png"})],-1)),n("div",H,[k(n("input",{ref:"nameInput","onUpdate:modelValue":e[0]||(e[0]=o=>t.formState.username=o),type:"text",placeholder:"请输入账号",onfocus:"this.placeholder=''",onBlur:e[1]||(e[1]=o=>t.onblur())},null,544),[[w,t.formState.username]]),e[4]||(e[4]=n("div",{class:"login-center-input-text"},"账号",-1))])]),n("div",W,[e[7]||(e[7]=n("div",{class:"login-center-img"},[n("img",{src:"img/login/password.png"})],-1)),n("div",Y,[k(n("input",{ref:"pwdInput","onUpdate:modelValue":e[2]||(e[2]=o=>t.formState.password=o),type:"password",placeholder:"请输入密码",onfocus:"this.placeholder=''",onBlur:e[3]||(e[3]=o=>t.onblur()),onKeyup:$(t.handleSubmit,["enter"])},null,544),[[w,t.formState.password]]),e[6]||(e[6]=n("div",{class:"login-center-input-text"},"密码",-1))])]),n("div",{class:"login-button",onClick:t.handleSubmit},"登录"),n("div",ee,[e[8]||(e[8]=n("span",null,"忘记密码",-1)),m(I,{vertical:""}),e[9]||(e[9]=n("span",null,"注册新账号",-1))])],64)}const ne=S(Z,[["render",te],["__file","AccountLogin.vue"]]),x=1e3*60,oe=h({__name:"QRCodeLogin",setup(C,{expose:e}){e();let s,t=p(""),i=p(!1),g=p(""),o;function c(){if(!o&&!o.connectionId)return;const l=T().query.sysid,a=o.connectionId;A("/api/getqrcode","https://gis-auth.digsur.com",{connId:a,sys:l??""},void 0,"blob").then(v=>{r.Logger().log("axios调用结果",v),i.value=!1,f();let U=URL.createObjectURL(v.data);t.value=U})}function f(){r.Logger().log("重新开始计时……"),s&&clearTimeout(s),s=setTimeout(()=>{i.value=!0},x)}function R(){const l=P("http://192.168.1.123:5000/chathub");l&&(o=l,l.start().then(()=>{l.state==="Connected"&&(o=l,c())}).catch(a=>{r.Logger().error("连接SignalR服务出错了！",a)}),l.on("QRCodeCheckMessage",function(a,d){d&&a&&(g.value=a),r.Logger().log("QRCodeCheckMessage",a,d)}),l.on("QRCodeSendMessage",function(a){let d=JSON.parse(a);if(r.Logger().log("QRCodeSendMessage",d),d?.Success){let b=d?.Userinfo.Doubletoken.AccessToken.TokenContent;if(d.System){r.Logger().info("当前登录id",d.System);const U=D("");window.open(U+"?tk="+b,"_self")}else r.OneUserInfo=d.Userinfo,Q().push("onelogin-portal")}else g.value="",c(),r.Message.warn("登录失败！请重新扫码登录")}))}R(),j(()=>{f()}),q(()=>{clearTimeout(s),o&&(o.off("QRCodeCheckMessage"),o.off("QRCodeSendMessage"),o.stop())});const B={get timerId(){return s},set timerId(u){s=u},timeout:x,get imgUrl(){return t},set imgUrl(u){t=u},get needRefresh(){return i},set needRefresh(u){i=u},get codeName(){return g},set codeName(u){g=u},get signalRConnection(){return o},set signalRConnection(u){o=u},getLoginQRCode:c,resetTimeOut:f,init:R};return Object.defineProperty(B,"__isScriptSetup",{enumerable:!1,value:!0}),B}}),se={class:"login-center"},ie={key:0,class:"box"},re={class:"imgInfo"},le={key:0,class:"mask"},ue=["src"],ae={class:"login-bottom-line"};function de(C,e,s,t,i,g){return _(),y("div",null,[e[3]||(e[3]=n("div",{class:"login-top-center"},"扫码登录",-1)),n("div",se,[t.codeName?(_(),y("div",ie,[n("span",null,V(t.codeName)+"正在登录...",1)])):(_(),y("div",{key:1,class:"box",onClick:t.getLoginQRCode},[e[0]||(e[0]=n("div",{class:"scaninfo"},"请打开微信小程序【帝测授权宝】扫码登录",-1)),n("div",re,[t.needRefresh&&t.imgUrl?(_(),y("div",le,[m(E,{flat:"",color:"primary",label:"点我刷新"})])):z("",!0),n("img",{src:t.imgUrl,alt:"用户登录二维码",style:{width:"100%"}},null,8,ue)])])),n("div",ae,[e[1]||(e[1]=n("span",null,"密码登录",-1)),m(I,{dark:"",vertical:""}),e[2]||(e[2]=n("span",null,"注册新账号",-1))])])])}const ce=S(oe,[["render",de],["__scopeId","data-v-0ee0d0ff"],["__file","QRCodeLogin.vue"]]),ge=h({__name:"index",setup(C,{expose:e}){e(),r.Loading("end");const s=p("");s.value=r.Config.UI?.SiteTitle;const t=p("");t.value=r.Config.UI?.CopyRight;const i=p("2"),g=J(()=>{let f="right-login-switch right-login-qrcode";return i.value==="2"&&(f="right-login-switch right-login-account"),f});function o(){i.value==="1"?i.value="2":i.value="1"}const c={systemTitle:s,copyRightInfo:t,activeKey:i,getRightStyle:g,changeLoginType:o,AccountLogin:ne,QRCodeLogin:ce};return Object.defineProperty(c,"__isScriptSetup",{enumerable:!1,value:!0}),c}}),fe={class:"container"},me={class:"login"},pe={class:"login-copyright"};function ve(C,e,s,t,i,g){return _(),y("div",fe,[e[2]||(e[2]=n("div",{class:"login-logo"},[n("img",{src:"img/logo.png",alt:""}),n("span",{class:"login-title"},"统一用户登录")],-1)),n("div",me,[n("div",{class:X(t.getRightStyle),onClick:e[0]||(e[0]=o=>t.changeLoginType())},null,2),m(M,{modelValue:t.activeKey,"onUpdate:modelValue":e[1]||(e[1]=o=>t.activeKey=o),animated:"",class:"shadow-2 rounded-borders"},{default:L(()=>[m(F,{name:"1"},{default:L(()=>[m(t.AccountLogin)]),_:1}),m(F,{name:"2"},{default:L(()=>[m(t.QRCodeLogin)]),_:1})]),_:1},8,["modelValue"])]),n("div",pe,V(t.copyRightInfo),1)])}const Se=S(ge,[["render",ve],["__scopeId","data-v-76376cb2"],["__file","index.vue"]]);export{Se as default};
