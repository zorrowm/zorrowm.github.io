import{ak as x,H as V,ag as h,ah as D}from"./vendor-BjjxFmO4.js";import{F as s,w as B,V as O,D as N}from"./xframelib-exp-B5TZbF78.js";import{d as k,e as q,r as g,O as f,S as v,U as t,D as L,ac as I,Z as A,c,F,b as K,B as P,C as _,a2 as S,W as j,a as z,Y as E,_ as w}from"./@vue-exp-18LRBxdm.js";import{g as T}from"./urlUtils-DeiOINk8.js";import{b as $,u as Q}from"./vue-router-exp-CvNwyAs-.js";import{_ as M}from"./index-Dxssf89i.js";import"./ol-exp-BZzGrai6.js";import"./axios-exp-C7rfqWEd.js";import"./@iconify/vue-exp-C65O8cJc.js";import"./monaco-editor-exp-BNK_u0iZ.js";const H={class:"login-center clearfix"},J={class:"login-center-input"},W={class:"login-center clearfix"},Y={class:"login-center-input"},Z={class:"login-bottom-line"},G=k({__name:"AccountLogin",setup(b){const n=q({username:"",password:""}),d=g(),i=g(),l=$().query.sysid;let a=!0;const r=async()=>{if(!a){s.Logger().debug("频繁点击登录******");return}if(a=!1,n.username.trim()===""||n.password.trim()=="")return setTimeout(()=>{a=!0},2e3),s.Message.warn("用户名或密码不能为空！");let y={username:n.username.trim(),pwd:n.password.trim()};const e=await B(y).catch(o=>{s.Message.warn(`登录失败:${o.message}!`),a=!0});if(e){const o=e.Userinfo.Doubletoken.AccessToken.TokenContent;if(l){s.Logger().info("当前登录id",e.System);const R=T("");window.open(R+"?tk="+o,"_self")}else s.OneUserInfo=e.Userinfo,Q().push("onelogin-portal")}};function m(){d.value&&(d.value.placeholder="请输入账号"),i.value&&(i.value.placeholder="请输入密码")}return(y,e)=>(f(),v(F,null,[e[10]||(e[10]=t("div",{class:"login-top-center"},"用户登录",-1)),t("div",H,[e[5]||(e[5]=t("div",{class:"login-center-img"},[t("img",{src:"img/login/name.png"})],-1)),t("div",J,[L(t("input",{ref_key:"nameInput",ref:d,"onUpdate:modelValue":e[0]||(e[0]=o=>n.username=o),type:"text",placeholder:"请输入账号",onfocus:"this.placeholder=''",onBlur:e[1]||(e[1]=o=>m())},null,544),[[I,n.username]]),e[4]||(e[4]=t("div",{class:"login-center-input-text"},"账号",-1))])]),t("div",W,[e[7]||(e[7]=t("div",{class:"login-center-img"},[t("img",{src:"img/login/password.png"})],-1)),t("div",Y,[L(t("input",{ref_key:"pwdInput",ref:i,"onUpdate:modelValue":e[2]||(e[2]=o=>n.password=o),type:"password",placeholder:"请输入密码",onfocus:"this.placeholder=''",onBlur:e[3]||(e[3]=o=>m()),onKeyup:A(r,["enter"])},null,544),[[I,n.password]]),e[6]||(e[6]=t("div",{class:"login-center-input-text"},"密码",-1))])]),t("div",{class:"login-button",onClick:r},"登录"),t("div",Z,[e[8]||(e[8]=t("span",null,"忘记密码",-1)),c(x,{vertical:""}),e[9]||(e[9]=t("span",null,"注册新账号",-1))])],64))}}),X={class:"login-center"},ee={key:0,class:"box"},te={class:"imgInfo"},oe={key:0,class:"mask"},se=["src"],ne={class:"login-bottom-line"},ie=1e3*60,le=k({__name:"QRCodeLogin",setup(b){let n,d=g(""),i=g(!1),p=g(""),l;function a(){if(!l&&!l.connectionId)return;const e=$().query.sysid,o=l.connectionId;N("/api/getqrcode","https://gis-auth.digsur.com",{connId:o,sys:e??""},void 0,"blob").then(U=>{s.Logger().log("axios调用结果",U),i.value=!1,r();let C=URL.createObjectURL(U.data);d.value=C})}function r(){s.Logger().log("重新开始计时……"),n&&clearTimeout(n),n=setTimeout(()=>{i.value=!0},ie)}function m(){const e=O("http://192.168.1.123:5000/chathub");e&&(l=e,e.start().then(()=>{e.state==="Connected"&&(l=e,a())}).catch(o=>{s.Logger().error("连接SignalR服务出错了！",o)}),e.on("QRCodeCheckMessage",function(o,u){u&&o&&(p.value=o),s.Logger().log("QRCodeCheckMessage",o,u)}),e.on("QRCodeSendMessage",function(o){let u=JSON.parse(o);if(s.Logger().log("QRCodeSendMessage",u),u?.Success){let R=u?.Userinfo.Doubletoken.AccessToken.TokenContent;if(u.System){s.Logger().info("当前登录id",u.System);const C=T("");window.open(C+"?tk="+R,"_self")}else s.OneUserInfo=u.Userinfo,Q().push("onelogin-portal")}else p.value="",a(),s.Message.warn("登录失败！请重新扫码登录")}))}return m(),K(()=>{r()}),P(()=>{clearTimeout(n),l&&(l.off("QRCodeCheckMessage"),l.off("QRCodeSendMessage"),l.stop())}),(y,e)=>(f(),v("div",null,[e[3]||(e[3]=t("div",{class:"login-top-center"},"扫码登录",-1)),t("div",X,[_(p)?(f(),v("div",ee,[t("span",null,S(_(p))+"正在登录...",1)])):(f(),v("div",{key:1,class:"box",onClick:a},[e[0]||(e[0]=t("div",{class:"scaninfo"},"请打开微信小程序【帝测授权宝】扫码登录",-1)),t("div",te,[_(i)&&_(d)?(f(),v("div",oe,[c(V,{flat:"",color:"primary",label:"点我刷新"})])):j("",!0),t("img",{src:_(d),alt:"用户登录二维码",style:{width:"100%"}},null,8,se)])])),t("div",ne,[e[1]||(e[1]=t("span",null,"密码登录",-1)),c(x,{dark:"",vertical:""}),e[2]||(e[2]=t("span",null,"注册新账号",-1))])])]))}}),ae=M(le,[["__scopeId","data-v-0ee0d0ff"]]),re={class:"container"},ue={class:"login"},de={class:"login-copyright"},ce=k({__name:"index",setup(b){s.Loading("end");const n=g("");n.value=s.Config.UI?.SiteTitle;const d=g("");d.value=s.Config.UI?.CopyRight;const i=g("2"),p=z(()=>{let a="right-login-switch right-login-qrcode";return i.value==="2"&&(a="right-login-switch right-login-account"),a});function l(){i.value==="1"?i.value="2":i.value="1"}return(a,r)=>(f(),v("div",re,[r[2]||(r[2]=t("div",{class:"login-logo"},[t("img",{src:"img/logo.png",alt:""}),t("span",{class:"login-title"},"统一用户登录")],-1)),t("div",ue,[t("div",{class:E(p.value),onClick:r[0]||(r[0]=m=>l())},null,2),c(D,{modelValue:i.value,"onUpdate:modelValue":r[1]||(r[1]=m=>i.value=m),animated:"",class:"shadow-2 rounded-borders"},{default:w(()=>[c(h,{name:"1"},{default:w(()=>[c(G)]),_:1}),c(h,{name:"2"},{default:w(()=>[c(ae)]),_:1})]),_:1},8,["modelValue"])]),t("div",de,S(d.value),1)]))}}),we=M(ce,[["__scopeId","data-v-76376cb2"]]);export{we as default};
