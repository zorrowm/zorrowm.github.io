/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
const e=Symbol("Comlink.proxy"),r=Symbol("Comlink.endpoint"),t=Symbol("Comlink.releaseProxy"),n=Symbol("Comlink.finalizer"),a=Symbol("Comlink.thrown"),o=e=>"object"==typeof e&&null!==e||"function"==typeof e,i=new Map([["proxy",{canHandle:r=>o(r)&&r[e],serialize(e){const{port1:r,port2:t}=new MessageChannel;return s(e,r),[t,[t]]},deserialize:e=>(e.start(),function(e){const r=new Map;return e.addEventListener("message",(function(e){const{data:t}=e;if(!t||!t.id)return;const n=r.get(t.id);if(n)try{n(t)}finally{r.delete(t.id)}})),h(e,r,[],void 0)}(e))}],["throw",{canHandle:e=>o(e)&&a in e,serialize({value:e}){let r;return r=e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[r,[]]},deserialize(e){if(e.isError)throw Object.assign(new Error(e.value.message),e.value);throw e.value}}]]);function s(r,t=globalThis,o=["*"]){t.addEventListener("message",(function i(u){if(!u||!u.data)return;if(!function(e,r){for(const t of e){if(r===t||"*"===t)return!0;if(t instanceof RegExp&&t.test(r))return!0}return!1}(o,u.origin))return;const{id:l,type:f,path:g}=Object.assign({path:[]},u.data),h=(u.data.argumentList||[]).map(w);let p;try{const t=g.slice(0,-1).reduce(((e,r)=>e[r]),r),n=g.reduce(((e,r)=>e[r]),r);switch(f){case"GET":p=n;break;case"SET":t[g.slice(-1)[0]]=w(u.data.value),p=!0;break;case"APPLY":p=n.apply(t,h);break;case"CONSTRUCT":v=new n(...h),p=Object.assign(v,{[e]:!0});break;case"ENDPOINT":{const{port1:e,port2:t}=new MessageChannel;s(r,t),p=function(e,r){return y.set(e,r),e}(e,[e])}break;case"RELEASE":p=void 0;break;default:return}}catch(b){p={value:b,[a]:0}}var v;Promise.resolve(p).catch((e=>({value:e,[a]:0}))).then((e=>{const[a,o]=d(e);t.postMessage(Object.assign(Object.assign({},a),{id:l}),o),"RELEASE"===f&&(t.removeEventListener("message",i),c(t),n in r&&"function"==typeof r[n]&&r[n]())})).catch((e=>{const[r,n]=d({value:new TypeError("Unserializable return value"),[a]:0});t.postMessage(Object.assign(Object.assign({},r),{id:l}),n)}))})),t.start&&t.start()}function c(e){"MessagePort"===e.constructor.name&&e.close()}function u(e){if(e)throw new Error("Proxy has been released and is not useable")}function l(e){return v(e,new Map,{type:"RELEASE"}).then((()=>{c(e)}))}const f=new WeakMap,g="FinalizationRegistry"in globalThis&&new FinalizationRegistry((e=>{const r=(f.get(e)||0)-1;f.set(e,r),0===r&&l(e)}));function h(e,n,a=[],o=function(){}){let i=!1;const s=new Proxy(o,{get(r,o){if(u(i),o===t)return()=>{var r;r=s,g&&g.unregister(r),l(e),n.clear(),i=!0};if("then"===o){if(0===a.length)return{then:()=>s};const r=v(e,n,{type:"GET",path:a.map((e=>e.toString()))}).then(w);return r.then.bind(r)}return h(e,n,[...a,o])},set(r,t,o){u(i);const[s,c]=d(o);return v(e,n,{type:"SET",path:[...a,t].map((e=>e.toString())),value:s},c).then(w)},apply(t,o,s){u(i);const c=a[a.length-1];if(c===r)return v(e,n,{type:"ENDPOINT"}).then(w);if("bind"===c)return h(e,n,a.slice(0,-1));const[l,f]=p(s);return v(e,n,{type:"APPLY",path:a.map((e=>e.toString())),argumentList:l},f).then(w)},construct(r,t){u(i);const[o,s]=p(t);return v(e,n,{type:"CONSTRUCT",path:a.map((e=>e.toString())),argumentList:o},s).then(w)}});return function(e,r){const t=(f.get(r)||0)+1;f.set(r,t),g&&g.register(e,r,e)}(s,e),s}function p(e){const r=e.map(d);return[r.map((e=>e[0])),(t=r.map((e=>e[1])),Array.prototype.concat.apply([],t))];var t}const y=new WeakMap;function d(e){for(const[r,t]of i)if(t.canHandle(e)){const[n,a]=t.serialize(e);return[{type:"HANDLER",name:r,value:n},a]}return[{type:"RAW",value:e},y.get(e)||[]]}function w(e){switch(e.type){case"HANDLER":return i.get(e.name).deserialize(e.value);case"RAW":return e.value}}function v(e,r,t,n){return new Promise((a=>{const o=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");r.set(o,a),e.start&&e.start(),e.postMessage(Object.assign({id:o},t),n)}))}let b=!0;try{String.fromCharCode.apply(String,[1,2])}catch(O){b=!1,Object.defineProperty(Array.prototype,"subarray",{value:Array.prototype.slice})}var m=2654435769;function E(e,r){var t=e.length,n=t<<2;if(r){var a=e[t-1];if(a<(n-=4)-3||a>n)return null;n=a}for(var o=new Uint8Array(n),i=0;i<n;++i)o[i]=e[i>>2]>>((3&i)<<3);return o}function S(e,r){var t,n=e.length,a=n>>2;3&n&&++a,r?(t=new Uint32Array(a+1))[a]=n:t=new Uint32Array(a);for(var o=0;o<n;++o)t[o>>2]|=e[o]<<((3&o)<<3);return t}function C(e){return 4294967295&e}function A(e,r,t,n,a,o){return(t>>>5^r<<2)+(r>>>3^t<<4)^(e^r)+(o[3&n^a]^t)}function T(e){if(e.length<16){var r=new Uint8Array(16);r.set(e),e=r}return e}function U(e){for(var r=e.length,t=new Uint8Array(3*r),n=0,a=0;a<r;a++){var o=e.charCodeAt(a);if(o<128)t[n++]=o;else if(o<2048)t[n++]=192|o>>6,t[n++]=128|63&o;else{if(!(o<55296||o>57343)){if(a+1<r){var i=e.charCodeAt(a+1);if(o<56320&&56320<=i&&i<=57343){var s=65536+((1023&o)<<10|1023&i);t[n++]=240|s>>18,t[n++]=128|s>>12&63,t[n++]=128|s>>6&63,t[n++]=128|63&s,a++;continue}}throw new Error("Malformed string")}t[n++]=224|o>>12,t[n++]=128|o>>6&63,t[n++]=128|63&o}}return t.subarray(0,n)}function k(e){var r=e.length;return 0===r?"":r<32767?function(e,r){for(var t=new Array(r),n=0,a=0,o=e.length;n<r&&a<o;n++){var i=e[a++];switch(i>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:t[n]=i;break;case 12:case 13:if(!(a<o))throw new Error("Unfinished UTF-8 octet sequence");t[n]=(31&i)<<6|63&e[a++];break;case 14:if(!(a+1<o))throw new Error("Unfinished UTF-8 octet sequence");t[n]=(15&i)<<12|(63&e[a++])<<6|63&e[a++];break;case 15:if(!(a+2<o))throw new Error("Unfinished UTF-8 octet sequence");var s=((7&i)<<18|(63&e[a++])<<12|(63&e[a++])<<6|63&e[a++])-65536;if(!(0<=s&&s<=1048575))throw new Error("Character outside valid Unicode range: 0x"+s.toString(16));t[n++]=s>>10&1023|55296,t[n]=1023&s|56320;break;default:throw new Error("Bad UTF-8 encoding 0x"+i.toString(16))}}return n<r&&(t.length=n),String.fromCharCode.apply(String,t)}(e,r):function(e,r){for(var t=[],n=new Array(32768),a=0,o=0,i=e.length;a<r&&o<i;a++){var s=e[o++];switch(s>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:n[a]=s;break;case 12:case 13:if(!(o<i))throw new Error("Unfinished UTF-8 octet sequence");n[a]=(31&s)<<6|63&e[o++];break;case 14:if(!(o+1<i))throw new Error("Unfinished UTF-8 octet sequence");n[a]=(15&s)<<12|(63&e[o++])<<6|63&e[o++];break;case 15:if(!(o+2<i))throw new Error("Unfinished UTF-8 octet sequence");var c=((7&s)<<18|(63&e[o++])<<12|(63&e[o++])<<6|63&e[o++])-65536;if(!(0<=c&&c<=1048575))throw new Error("Character outside valid Unicode range: 0x"+c.toString(16));n[a++]=c>>10&1023|55296,n[a]=1023&c|56320;break;default:throw new Error("Bad UTF-8 encoding 0x"+s.toString(16))}if(a>=32766){var u=a+1;n.length=u,t.push(String.fromCharCode.apply(String,n)),r-=u,a=-1}}return a>0&&(n.length=a,t.push(String.fromCharCode.apply(String,n))),t.join("")}(e,r)}function M(e,r){return"string"==typeof e&&(e=U(e)),"string"==typeof r&&(r=U(r)),null==e||0===e.length?e:E(function(e,r){var t,n,a,o,i,s,c=e.length,u=c-1;for(n=e[u],a=0,s=0|Math.floor(6+52/c);s>0;--s){for(o=(a=C(a+m))>>>2&3,i=0;i<u;++i)t=e[i+1],n=e[i]=C(e[i]+A(a,t,n,i,o,r));t=e[0],n=e[u]=C(e[u]+A(a,t,n,u,o,r))}return e}(S(e,!0),S(T(r),!1)),!1)}function j(e,r){return"string"==typeof e&&(e=function(e){for(var r=globalThis.atob(e),t=r.length,n=new Uint8Array(t),a=0;a<t;a++)n[a]=r.charCodeAt(a);return n}(e)),"string"==typeof r&&(r=U(r)),null==e||0===e.length?e:E(function(e,r){var t,n,a,o,i,s=e.length,c=s-1;for(t=e[0],a=C(Math.floor(6+52/s)*m);0!==a;a=C(a-m)){for(o=a>>>2&3,i=c;i>0;--i)n=e[i-1],t=e[i]=C(e[i]-A(a,t,n,i,o,r));n=e[c],t=e[0]=C(e[0]-A(a,t,n,0,o,r))}return e}(S(e,!1),S(T(r),!1)),!0)}s(Object.freeze({__proto__:null,decrypt:j,decryptToString:function(e,r){return k(j(e,r))},encrypt:M,encryptToString:function(e,r){return globalThis.btoa(function(e){var r=e.length;if(0===r)return"";var t=b?e:function(e){for(var r=e.length,t=new Array(e.length),n=0;n<r;++n)t[n]=e[n];return t}(e);if(r<65535)return String.fromCharCode.apply(String,t);for(var n=32767&r,a=r>>15,o=new Array(n?a+1:a),i=0;i<a;++i)o[i]=String.fromCharCode.apply(String,t.subarray(i<<15,i+1<<15));return n&&(o[a]=String.fromCharCode.apply(String,t.subarray(a<<15,r))),o.join("")}(M(e,r)))},toBytes:U,toString:k}));
