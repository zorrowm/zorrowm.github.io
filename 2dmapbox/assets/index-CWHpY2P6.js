import{Y as I,A as V,ax as F,ay as E}from"./vendor-qEPl7M71.js";import{B as u,P as N,o as P,C as A}from"./xframelib-exp-CBRV2soX.js";import{g as D}from"./urlUtils-BY_cFLPx.js";import{b as Q,u as T}from"./vue-router-exp-U1sBIDGE.js";import{d as h,r as O,a as p,L as C,M as y,N as n,D as k,ac as w,Z as $,e as f,F as K,o as j,C as q,a2 as M,X as Y,c as z,Y as J,_ as U}from"./@vue-exp-Cbz_CXqa.js";import{_ as S}from"./index-XTFg7KW3.js";import"./axios-exp-B_zfNCMU.js";import"./@iconify/vue-exp-BeT9ZUzB.js";import"./monaco-editor-exp-B01XOe8A.js";const X=h({__name:"AccountLogin",setup(R,{expose:e}){e();const s=O({username:"",password:""}),t=p(),i=p(),c=Q(),o=c.query.sysid;let a=!0,m=!1;const b=async()=>{if(!a){u.Logger().debug("频繁点击登录******");return}if(a=!1,s.username.trim()===""||s.password.trim()=="")return setTimeout(()=>{a=!0},2e3),u.Message.warn("用户名或密码不能为空！");let r={username:s.username.trim(),pwd:s.password.trim()};const l=await N(r).catch(v=>{u.Message.warn(`登录失败:${v.message}!`),a=!0});if(l){const v=l.Userinfo.Doubletoken.AccessToken.TokenContent;if(o){u.Logger().info("当前登录id",l.System);const B=D("");window.open(B+"?tk="+v,"_self")}else u.OneUserInfo=l.Userinfo,T().push("onelogin-portal")}};function L(){t.value&&(t.value.placeholder="请输入账号"),i.value&&(i.value.placeholder="请输入密码")}function d(r){m=!0;const{time:l}=r;u.Message.info(`校验成功,耗时${l}秒`)}const g={formState:s,nameInput:t,pwdInput:i,currentRoute:c,systemID:o,get canLoginClicked(){return a},set canLoginClicked(r){a=r},get isPassVerify(){return m},set isPassVerify(r){m=r},handleSubmit:b,onblur:L,handleSuccess:d};return Object.defineProperty(g,"__isScriptSetup",{enumerable:!1,value:!0}),g}}),Z={class:"login-center clearfix"},G={class:"login-center-input"},H={class:"login-center clearfix"},W={class:"login-center-input"},ee={class:"login-bottom-line"};function te(R,e,s,t,i,c){return C(),y(K,null,[e[10]||(e[10]=n("div",{class:"login-top-center"},"用户登录",-1)),n("div",Z,[e[5]||(e[5]=n("div",{class:"login-center-img"},[n("img",{src:"img/login/name.png"})],-1)),n("div",G,[k(n("input",{ref:"nameInput","onUpdate:modelValue":e[0]||(e[0]=o=>t.formState.username=o),type:"text",placeholder:"请输入账号",onfocus:"this.placeholder=''",onBlur:e[1]||(e[1]=o=>t.onblur())},null,544),[[w,t.formState.username]]),e[4]||(e[4]=n("div",{class:"login-center-input-text"},"账号",-1))])]),n("div",H,[e[7]||(e[7]=n("div",{class:"login-center-img"},[n("img",{src:"img/login/password.png"})],-1)),n("div",W,[k(n("input",{ref:"pwdInput","onUpdate:modelValue":e[2]||(e[2]=o=>t.formState.password=o),type:"password",placeholder:"请输入密码",onfocus:"this.placeholder=''",onBlur:e[3]||(e[3]=o=>t.onblur()),onKeyup:$(t.handleSubmit,["enter"])},null,544),[[w,t.formState.password]]),e[6]||(e[6]=n("div",{class:"login-center-input-text"},"密码",-1))])]),e[11]||(e[11]=n("div",{class:"login-center clearfix",style:{"margin-bottom":"5px"}},null,-1)),n("div",{class:"login-button",onClick:t.handleSubmit},"登录"),n("div",ee,[e[8]||(e[8]=n("span",null,"忘记密码",-1)),f(I,{vertical:""}),e[9]||(e[9]=n("span",null,"注册新账号",-1))])],64)}const ne=S(X,[["render",te],["__file","AccountLogin.vue"]]),x=1e3*60,oe=h({__name:"QRCodeLogin",setup(R,{expose:e}){e();let s,t=p(""),i=p(!1),c=p(""),o;function a(){if(!o&&!o.connectionId)return;const g=Q().query.sysid,r=o.connectionId;A("/api/getqrcode","https://gis-auth.digsur.com",{connId:r,sys:g??""},void 0,"blob").then(_=>{u.Logger().log("axios调用结果",_),i.value=!1,m();let B=URL.createObjectURL(_.data);t.value=B})}function m(){u.Logger().log("重新开始计时……"),s&&clearTimeout(s),s=setTimeout(()=>{i.value=!0},x)}function b(){const g=P("http://192.168.1.123:5000/chathub");g&&(o=g,g.start().then(()=>{g.state==="Connected"&&(o=g,a())}).catch(r=>{u.Logger().error("连接SignalR服务出错了！",r)}),g.on("QRCodeCheckMessage",function(r,l){l&&r&&(c.value=r),u.Logger().log("QRCodeCheckMessage",r,l)}),g.on("QRCodeSendMessage",function(r){let l=JSON.parse(r);if(u.Logger().log("QRCodeSendMessage",l),l?.Success){let v=l?.Userinfo.Doubletoken.AccessToken.TokenContent;if(l.System){u.Logger().info("当前登录id",l.System);const B=D("");window.open(B+"?tk="+v,"_self")}else u.OneUserInfo=l.Userinfo,T().push("onelogin-portal")}else c.value="",a(),u.Message.warn("登录失败！请重新扫码登录")}))}b(),j(()=>{m()}),q(()=>{clearTimeout(s),o&&(o.off("QRCodeCheckMessage"),o.off("QRCodeSendMessage"),o.stop())});const L={get timerId(){return s},set timerId(d){s=d},timeout:x,get imgUrl(){return t},set imgUrl(d){t=d},get needRefresh(){return i},set needRefresh(d){i=d},get codeName(){return c},set codeName(d){c=d},get signalRConnection(){return o},set signalRConnection(d){o=d},getLoginQRCode:a,resetTimeOut:m,init:b};return Object.defineProperty(L,"__isScriptSetup",{enumerable:!1,value:!0}),L}}),se={class:"login-center"},ie={key:0,class:"box"},re={class:"imgInfo"},le={key:0,class:"mask"},ue=["src"],ae={class:"login-bottom-line"};function de(R,e,s,t,i,c){return C(),y("div",null,[e[3]||(e[3]=n("div",{class:"login-top-center"},"扫码登录",-1)),n("div",se,[t.codeName?(C(),y("div",ie,[n("span",null,M(t.codeName)+"正在登录...",1)])):(C(),y("div",{key:1,class:"box",onClick:t.getLoginQRCode},[e[0]||(e[0]=n("div",{class:"scaninfo"},"请打开微信小程序【帝测授权宝】扫码登录",-1)),n("div",re,[t.needRefresh&&t.imgUrl?(C(),y("div",le,[f(V,{flat:"",color:"primary",label:"点我刷新"})])):Y("",!0),n("img",{src:t.imgUrl,alt:"用户登录二维码",style:{width:"100%"}},null,8,ue)])])),n("div",ae,[e[1]||(e[1]=n("span",null,"密码登录",-1)),f(I,{dark:"",vertical:""}),e[2]||(e[2]=n("span",null,"注册新账号",-1))])])])}const ce=S(oe,[["render",de],["__scopeId","data-v-0ee0d0ff"],["__file","QRCodeLogin.vue"]]),ge=h({__name:"index",setup(R,{expose:e}){e(),u.Loading("end");const s=p("");s.value=u.Config.UI?.SiteTitle;const t=p("");t.value=u.Config.UI?.CopyRight;const i=p("2"),c=z(()=>{let m="right-login-switch right-login-qrcode";return i.value==="2"&&(m="right-login-switch right-login-account"),m});function o(){i.value==="1"?i.value="2":i.value="1"}const a={systemTitle:s,copyRightInfo:t,activeKey:i,getRightStyle:c,changeLoginType:o,AccountLogin:ne,QRCodeLogin:ce};return Object.defineProperty(a,"__isScriptSetup",{enumerable:!1,value:!0}),a}}),me={class:"container"},fe={class:"login"},pe={class:"login-copyright"};function ve(R,e,s,t,i,c){return C(),y("div",me,[e[2]||(e[2]=n("div",{class:"login-logo"},[n("img",{src:"img/logo.png",alt:""}),n("span",{class:"login-title"},"统一用户登录")],-1)),n("div",fe,[n("div",{class:J(t.getRightStyle),onClick:e[0]||(e[0]=o=>t.changeLoginType())},null,2),f(E,{modelValue:t.activeKey,"onUpdate:modelValue":e[1]||(e[1]=o=>t.activeKey=o),animated:"",class:"shadow-2 rounded-borders"},{default:U(()=>[f(F,{name:"1"},{default:U(()=>[f(t.AccountLogin)]),_:1}),f(F,{name:"2"},{default:U(()=>[f(t.QRCodeLogin)]),_:1})]),_:1},8,["modelValue"])]),n("div",pe,M(t.copyRightInfo),1)])}const Se=S(ge,[["render",ve],["__scopeId","data-v-76376cb2"],["__file","index.vue"]]);export{Se as default};
